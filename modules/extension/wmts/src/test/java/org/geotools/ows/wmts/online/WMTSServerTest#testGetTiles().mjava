    @Test
    public void testGetTiles()
            throws IOException, ServiceException, FactoryException, TransformException {
        WebMapTileServer wmts = new WebMapTileServer(server);

        WMTSCapabilities capabilities = wmts.getCapabilities();

        CoordinateReferenceSystem crs = CRS.decode("EPSG:25833");
        ReferencedEnvelope envelope =
                new ReferencedEnvelope(
                        -2500000, 3785956.059944782, 4366791.973583084, 9045984.0, crs);

        // envelope to request tiles for 5th zoom level
        ReferencedEnvelope re1 =
                new ReferencedEnvelope(
                        0.0, 469103.37588849873, 6345722.619929184, 6704879.892093816, crs);

        Set<Tile> responses =
                issueTileRequest(
                        wmts,
                        capabilities,
                        envelope,
                        re1,
                        crs,
                        "Trafikkportalen_GeocacheTrafikkJPG");
        assertFalse(responses.isEmpty());
        for (Tile response : responses) {
            // checking the identifier
            assertTrue(response.getId().startsWith("wmts_5"));
            re1.contains(response.getExtent().toBounds(re1.getCoordinateReferenceSystem()));
        }
        // envelope to request tiles for 7th zoom level
        ReferencedEnvelope re2 =
                new ReferencedEnvelope(
                        224917.44983375072,
                        338455.67691015685,
                        6545348.998732969,
                        6658887.225809376,
                        crs);
        Set<Tile> responses2 =
                issueTileRequest(
                        wmts,
                        capabilities,
                        envelope,
                        re2,
                        crs,
                        "Trafikkportalen_GeocacheTrafikkJPG");
        for (Tile response : responses2) {
            // checking the identifier
            assertTrue(response.getId().startsWith("wmts_7"));
            re2.contains(response.getExtent().toBounds(re2.getCoordinateReferenceSystem()));
        }
    }

