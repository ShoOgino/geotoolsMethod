    public void issueGetTileRequest(WebMapTileServer wmts)
            throws ServiceException, FactoryException {

        WMTSCapabilities capabilities = wmts.getCapabilities();

        GetTileRequest request = wmts.createGetTileRequest();

        // request.setVersion("1.1.1");

        WMTSLayer layer = (WMTSLayer) capabilities.getLayer("topp:states");
        assertNotNull(layer);
        request.setLayer(layer);

        request.setRequestedWidth(800);
        request.setRequestedHeight(400);

        String format = "image/png";
        List<String> formats = layer.getFormats();
        assertTrue(formats.size() > 0);
        if (!formats.contains("image/png")) {
            format = (String) formats.get(0);
        }
        // request.setFormat(format);

        ReferencedEnvelope re = new ReferencedEnvelope(-180, 180, -90, 90, CRS.decode("EPSG:4326"));
        request.setRequestedBBox(re);

        // System.out.println(request.getFinalURL());
        Set<Tile> responses = (Set<Tile>) wmts.issueRequest(request);
        assertFalse(responses.isEmpty());
        for (Tile response : responses) {
            // System.out.println("Content Type: " + response.getContentType());
            // System.out.println(response.getTileIdentifier());
            BufferedImage image = response.getBufferedImage();
            assertEquals(256, image.getHeight());
        }
    }

