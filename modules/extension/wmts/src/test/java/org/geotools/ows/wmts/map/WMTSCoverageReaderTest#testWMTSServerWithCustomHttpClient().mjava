    @Test
    public void testWMTSServerWithCustomHttpClient() throws Exception {
        // Test basic authentication properties are set for requests.
        // GetCapabilities request is dependent on HTTPClient class.
        // GetTile request is dependent on HttpClient class from common http library.
        final URL wmtsUrl = new URL("http://fake.local/wmts");

        // Mock HTTPClient
        final File kvpCapaFile = getResourceFile(KVP_CAPA_RESOURCENAME);
        HTTPResponse getCapabilitiesResponse =
                new MockHttpResponse(kvpCapaFile, "application/xml; UTF-8");

        final File worldFile = getResourceFile("test-data/world.png");
        HTTPResponse getTileResponse = new MockHttpResponse(worldFile, "application/xml; UTF-8");

        final Map<String, String> getTileHeadersCalled = new HashMap<>();

        HTTPClient owsHttpClient =
                new AbstractHttpClient() {

                    @Override
                    public HTTPResponse get(URL url) throws IOException {
                        throw new NotImplementedException(
                                "For this test. GET with headers should be called.\n"
                                        + url.toExternalForm());
                    }

                    @Override
                    public HTTPResponse get(URL url, Map<String, String> headers) {
                        getTileHeadersCalled.clear();
                        getTileHeadersCalled.putAll(headers);
                        if (url.toString().toLowerCase().contains("request=getcapabilities")) {
                            return getCapabilitiesResponse;
                        } else if (url.toString().toLowerCase().contains("request=gettile")) {
                            return getTileResponse;
                        } else {
                            throw new NotImplementedException(
                                    "request is not implemented. " + url.toString());
                        }
                    }

                    @Override
                    public HTTPResponse post(
                            URL url, InputStream postContent, String postContentType)
                            throws IOException {
                        throw new UnsupportedOperationException("POST shouldn't be called.");
                    }
                };
        owsHttpClient.setUser("username");
        owsHttpClient.setPassword("userpassword");

        WebMapTileServer server =
                new WebMapTileServer(
                        wmtsUrl, owsHttpClient, Collections.singletonMap("header1", "value1"));
        assertNotNull(server.getCapabilities());
        assertTrue(
                "Expected header1 in the GetCapabilities request",
                getTileHeadersCalled.containsKey("header1"));

        WMTSLayer layer = server.getCapabilities().getLayer("topp:states");
        WMTSCoverageReader wcr = new WMTSCoverageReader(server, layer);
        ReferencedEnvelope bbox =
                new ReferencedEnvelope(-180, 180, -90, 90, CRS.decode("EPSG:4326"));
        Set<Tile> responses = testInitMapRequest(wcr, bbox);
        assertFalse(responses.isEmpty());
        Tile firstTile = responses.iterator().next();
        BufferedImage bufferedImage = firstTile.getBufferedImage();
        assertNotNull(bufferedImage);

        // check headers defined at WebMapTileServer are sent with GetTileRequest
        assertNotNull(getTileHeadersCalled);
        assertTrue(
                "Expected header1 in the GetTile request",
                getTileHeadersCalled.containsKey("header1"));
    }

