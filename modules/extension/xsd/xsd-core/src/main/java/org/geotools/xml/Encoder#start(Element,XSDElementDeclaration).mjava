    protected void start(Element element, XSDElementDeclaration declaration) throws SAXException {
        String uri, local, qName;
        
        if (element.getLocalName() != null) {
            uri = element.getNamespaceURI();
            local = element.getLocalName();
        }
        else {
            //namespace unaware dom tree
            local = element.getNodeName();
            if (local.contains(":")) {
                String[] split = local.split(":");
                local = split[1];
                uri = namespaces.getURI(split[0]);
            }
            else {
                uri = null;
            }
        }
        qName = local;
        
        NamespaceSupport namespaces = this.namespaces;

        // declaration == null -> gml3 envelope encoding test failing
        // declaration.getSchema() == null -> wfs 2.0 feature collection encoding test failing
        if (forceQualified(declaration)) {
            uri = (uri != null) ? uri : namespaces.getURI("");
            qName = namespaces.getPrefix(uri) + ":" + qName;
            
        } else {
            uri = "";
        }

        DOMAttributes atts = new DOMAttributes(element.getAttributes(), namespaces);
        serializer.startElement(uri, local, qName, atts);

        //write out any text
        for (int i = 0; i < element.getChildNodes().getLength(); i++) {
            Node node = element.getChildNodes().item(i);

            if (node instanceof Text) {
                String data = XMLUtils.removeXMLInvalidChars(((Text) node).getData());
                char[] ch = data.toCharArray();
                serializer.characters(ch, 0, ch.length);
            }
        }

        //write out any child elements
        for (int i = 0; i < element.getChildNodes().getLength(); i++) {
            Node node = element.getChildNodes().item(i);

            if (node instanceof Element) {
                Element child = (Element) node;
                QName childName = new QName(child.getNamespaceURI(), child.getNodeName());
                XSDElementDeclaration childDecl = declaration != null ? 
                    Schemas.getChildElementDeclaration(declaration, childName) : null; 
                start(child, childDecl);
                end(child, childDecl);
            }
        }

        //push a new context for children, declaring the default prefix to be the one of this 
        // element
        this.namespaces.pushContext();

        if (uri != null) {
            this.namespaces.declarePrefix("", uri);
        }
    }

