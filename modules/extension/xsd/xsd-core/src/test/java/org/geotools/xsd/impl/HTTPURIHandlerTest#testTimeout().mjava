    @Test
    public void testTimeout() throws Exception {
        reset(conn);
        {
            conn.setConnectTimeout(anyInt());
            expectLastCall();
            conn.setReadTimeout(anyInt());
            expectLastCall();
            expect(conn.getInputStream()).andThrow(new IOException());
        }
        replay(conn);

        URI uri = URI.createURI("http://example.com");
        Assert.assertThrows(
                IOException.class,
                new ThrowingRunnable() {

                    @Override
                    public void run() throws Throwable {
                        handler.createInputStream(uri, Collections.EMPTY_MAP);
                    }
                });
    }

