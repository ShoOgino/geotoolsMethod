    /**
     * Find the source expression if the step is a client property.
     *
     * @param mapping attribute mapping
     * @param lastStep the last step
     */
    private Expression getClientPropertyExpression(AttributeMapping mapping, Step lastStep) {
        Expression exp = null;
        if (lastStep.isXmlAttribute()) {
            Map<Name, Expression> clientProperties = mapping.getClientProperties();
            QName lastStepQName = lastStep.getName();
            Name lastStepName;
            if (lastStepQName.getPrefix() != null
                    && lastStepQName.getPrefix().length() > 0
                    && (lastStepQName.getNamespaceURI() == null
                            || lastStepQName.getNamespaceURI().length() == 0)) {
                String prefix = lastStepQName.getPrefix();
                String uri = namespaceSupport.getURI(prefix);
                lastStepName = Types.typeName(uri, lastStepQName.getLocalPart());
            } else {
                lastStepName = Types.toTypeName(lastStepQName);
            }
            if (clientProperties.containsKey(lastStepName)) {
                // end NC - added
                exp = (Expression) clientProperties.get(lastStepName);
            } else if (XPath.isId(lastStep)) {
                if (mapping.getIdentifierExpression() == Expression.NIL) {
                    // no specific attribute mapping or that idExpression is not mapped
                    // use primary key
                    exp = CommonFactoryFinder.getFilterFactory(null).property("@id");
                } else {
                    exp = mapping.getIdentifierExpression();
                }
            }
        }
        return exp;
    }

