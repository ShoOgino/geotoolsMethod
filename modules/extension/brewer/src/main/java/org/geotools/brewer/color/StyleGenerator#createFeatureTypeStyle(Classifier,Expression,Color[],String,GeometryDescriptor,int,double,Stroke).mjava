    /**
     * Merges a classifier, array of colors and other data into a FeatureTypeStyle object. Yes, this
     * constructor is insane and likely to change very soon.
     *
     * @param typeId semantic type identifier, which will be prefixed with "colorbrewer:"
     */
    public static FeatureTypeStyle createFeatureTypeStyle(
            Classifier classifier,
            Expression expression,
            Color[] colors,
            String typeId,
            GeometryDescriptor geometryAttrType,
            int elseMode,
            double opacity,
            Stroke defaultStroke)
            throws IllegalFilterException {
        // init nulls
        if (defaultStroke == null) {
            defaultStroke = sb.createStroke();
        }

        // answer goes here
        FeatureTypeStyle fts = sf.createFeatureTypeStyle();

        // update the number of classes

        // numeric
        if (classifier instanceof RangedClassifier) {
            RangedClassifier ranged = (RangedClassifier) classifier;

            Object localMin = null;
            Object localMax = null;

            // for each class
            for (int i = 0; i < ranged.getSize(); i++) {
                // obtain min/max values
                localMin = ranged.getMin(i);
                localMax = ranged.getMax(i);

                Rule rule =
                        createRuleRanged(
                                ranged,
                                expression,
                                localMin,
                                localMax,
                                geometryAttrType,
                                i,
                                elseMode,
                                colors,
                                opacity,
                                defaultStroke);
                fts.rules().add(rule);
            }
        } else if (classifier instanceof ExplicitClassifier) {
            ExplicitClassifier explicit = (ExplicitClassifier) classifier;

            // for each class
            for (int i = 0; i < explicit.getSize(); i++) {
                Set value = explicit.getValues(i);
                Rule rule =
                        createRuleExplicit(
                                explicit,
                                expression,
                                value,
                                geometryAttrType,
                                i,
                                elseMode,
                                colors,
                                opacity,
                                defaultStroke);
                fts.rules().add(rule);
            }
        } else {
            LOGGER.log(Level.SEVERE, "Error: no handler for this Classifier type");
        }

        // add an else rule to capture any missing features?
        if (elseMode != ELSEMODE_IGNORE) {
            Symbolizer symb =
                    createSymbolizer(
                            geometryAttrType,
                            getElseColor(elseMode, colors),
                            opacity,
                            defaultStroke);
            Rule elseRule = sb.createRule(symb);
            elseRule.setElseFilter(true);
            elseRule.getDescription().setTitle("Else");
            elseRule.setName("else");
            fts.rules().add(elseRule);
        }

        // our syntax will be: ColorBrewer:id
        Set<SemanticType> semanticTypes = fts.semanticTypeIdentifiers();
        semanticTypes.add(SemanticType.valueOf("generic:geometry"));
        semanticTypes.add(SemanticType.valueOf("colorbrewer:" + typeId));

        return fts;
    }

