    /** @see org.geotools.data.wms.request.Request#getFinalURL() */
    public URL getFinalURL() {
        Iterator iter = queryLayers.iterator();
        String initialQueryLayerString =
                properties.getProperty(QUERY_LAYERS) == null
                        ? ""
                        : properties.getProperty(QUERY_LAYERS); // $NON-NLS-1$
        String queryLayerString =
                properties.getProperty(QUERY_LAYERS) == null
                        ? ""
                        : properties.getProperty(QUERY_LAYERS); // $NON-NLS-1$

        while (iter.hasNext()) {
            Layer layer = (Layer) iter.next();
            try {
                // spaces are converted to plus signs, but must be %20 for url calls [GEOT-4317]
                queryLayerString =
                        queryLayerString
                                + URLEncoder.encode(layer.getName(), "UTF-8")
                                        .replaceAll("\\+", "%20");
                ; // $NON-NLS-1$
            } catch (UnsupportedEncodingException | NullPointerException e) {
                queryLayerString = queryLayerString + layer.getName();
            }

            if (iter.hasNext()) {
                queryLayerString = queryLayerString + ","; // $NON-NLS-1$
            }
        }

        setProperty(QUERY_LAYERS, queryLayerString);
        URL url = super.getFinalURL();

        setProperty(QUERY_LAYERS, initialQueryLayerString);

        return url;
    }

