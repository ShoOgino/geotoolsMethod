    /**
     * Check GetMap request functionality in the provided CRS.
     *
     * <p>Attempt is made to request the entire image.
     */
    private void checkGetMap(WebMapServer wms, Layer layer, CoordinateReferenceSystem crs)
            throws Exception {

        layer.clearCache();
        CRSEnvelope latLon = layer.getLatLonBoundingBox();
        GeneralEnvelope envelope = wms.getEnvelope(layer, crs);
        Assert.assertFalse(envelope.isEmpty() || envelope.isNull() || envelope.isInfinite());
        Assert.assertNotNull("Envelope " + CRS.toSRS(crs), envelope);

        GetMapRequest getMap = wms.createGetMapRequest();
        OperationType operationType = wms.getCapabilities().getRequest().getGetMap();

        getMap.addLayer(layer);
        String version = wms.getCapabilities().getVersion();

        getMap.setBBox(envelope);

        Properties properties = getMap.getProperties();
        String srs = null;
        if (properties.containsKey("SRS")) {
            srs = properties.getProperty("SRS");
        } else if (properties.containsKey("CRS")) {
            srs = properties.getProperty("CRS");
        }
        Assert.assertNotNull("setBBox supplied SRS information", srs);
        String expectedSRS = CRS.toSRS(envelope.getCoordinateReferenceSystem());
        Assert.assertEquals("srs matches CRS.toSRS", expectedSRS, srs);

        Assert.assertTrue("cite authority:" + srs, srs.contains("CRS") || srs.contains("EPSG"));

        // getMap.setSRS( srs );

        String format = format(operationType, "jpeg");
        getMap.setFormat(format);
        getMap.setDimensions(500, 500);

        URL url = getMap.getFinalURL();
        GetMapResponse response = wms.issueRequest(getMap);
        Assert.assertEquals("image/jpeg", response.getContentType());

        InputStream stream = response.getInputStream();
        BufferedImage image = ImageIO.read(stream);
        Assert.assertNotNull("jpeg", image);
        Assert.assertEquals(500, image.getWidth());
        Assert.assertEquals(500, image.getHeight());

        int rgb = image.getRGB(70, 420);
        Color sample = new Color(rgb);
        boolean forceXY = Boolean.getBoolean(GeoTools.FORCE_LONGITUDE_FIRST_AXIS_ORDER);
        String context = "srs=" + srs + " forceXY=" + forceXY + " Version=" + version;
        if (Color.WHITE.equals(sample)) {
            // System.out.println("FAIL: " + context + ": GetMap BBOX=" + envelope);
            // System.out.println("--> " + url);
            Assert.fail(context + ": GetMap BBOX=" + envelope);
        } else {
            // System.out.println("PASS: "+ context+": GetMap BBOX=" + bbox);
        }
    }

