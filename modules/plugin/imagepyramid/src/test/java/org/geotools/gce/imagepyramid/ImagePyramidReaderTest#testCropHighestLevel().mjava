    /**
     * Testing {@link ImagePyramidReader} by cropping requesting a the best possible dimension.
     *
     * <p>The underlying pyramid i made by 4 levels on the same area, more or less italy, with
     * resolution decreasing as a power of 2.
     *
     * <p>Size of the original mosaic is 250,250.
     */
    @Test
    public void testCropHighestLevel()
            throws IOException, MismatchedDimensionException, NoSuchAuthorityCodeException {
        //
        // Get the resource.
        //
        final URL testFile = TestData.getResource(this, "goodpyramid/" + TEST_FILE);

        //
        // Get a reader
        //
        final AbstractGridFormat format = new ImagePyramidFormat();
        final ImagePyramidReader reader = (ImagePyramidReader) format.getReader(testFile);
        assertNotNull(reader);
        //
        // crop
        //
        final ParameterValue<GridGeometry2D> gg =
                ImageMosaicFormat.READ_GRIDGEOMETRY2D.createValue();
        final GeneralEnvelope oldEnvelop = reader.getOriginalEnvelope();
        final GeneralEnvelope cropEnvelope =
                new GeneralEnvelope(
                        new double[] {
                            oldEnvelop.getLowerCorner().getOrdinate(0),
                            oldEnvelop.getLowerCorner().getOrdinate(1)
                        },
                        new double[] {
                            oldEnvelop.getLowerCorner().getOrdinate(0) + oldEnvelop.getSpan(0) / 2,
                            oldEnvelop.getLowerCorner().getOrdinate(1) + oldEnvelop.getSpan(1) / 2
                        });
        cropEnvelope.setCoordinateReferenceSystem(DefaultGeographicCRS.WGS84);
        gg.setValue(
                new GridGeometry2D(
                        new GridEnvelope2D(new Rectangle(0, 0, 125, 125)), cropEnvelope));

        //
        // Show the coverage
        //
        GridCoverage2D coverage = reader.read(new GeneralParameterValue[] {gg});
        assertNotNull("Null value returned instead of a coverage", coverage);

        // used to match exactly, but now we compute the exact bbox matching the request on the fly
        assertEquals(127, coverage.getGridGeometry().getGridRange().getSpan(0), 5);
        assertEquals(127, coverage.getGridGeometry().getGridRange().getSpan(1), 5);
        if (TestData.isInteractiveTest()) coverage.show("testCropHighestLevel");
        else PlanarImage.wrapRenderedImage(coverage.getRenderedImage()).getTiles();
    }

