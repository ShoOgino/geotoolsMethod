        public String getFieldString(int size, String s) {
            buffer.replace(0, size, emptyString);
            buffer.setLength(size);
            // international characters must be accounted for so size != length.
            if (s != null) {
                int maxBytes = Math.min(size, s.length());
                buffer.replace(0, maxBytes, s);
                int currentBytes = buffer.toString().getBytes(charset).length;
                if (currentBytes > size) {
                    while (currentBytes > size) {
                        int index = buffer.length() - 1;
                        buffer.deleteCharAt(index);
                        currentBytes = buffer.toString().getBytes(charset).length;
                    }
                }
                // in sequence to the above step, rather than as an alternative, as the step above
                // might have removed a last char that was multi-byte, making the buffer short
                if (currentBytes < size) {
                    int diff = size - currentBytes;
                    for (int i = 0; i < diff; i++) {
                        buffer.append(' ');
                    }
                }
            }

            return buffer.toString();
        }

