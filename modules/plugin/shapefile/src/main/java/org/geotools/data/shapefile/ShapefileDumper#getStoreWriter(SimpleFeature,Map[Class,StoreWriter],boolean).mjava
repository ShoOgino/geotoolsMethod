    /**
     * Returns the feature writer for a specific geometry type, creates a new datastore and a new writer if there are none so far
     */
    private StoreWriter getStoreWriter(SimpleFeature f,
            Map<Class, StoreWriter> writers, boolean multiWriter) throws IOException {

        // get the target class
        Class<?> target = null;
        String geometryType = null;
        if (multiWriter) {
            Map<String, Object> map = getGeometryType(f);
            target = (Class<?>) map.get("target");
            geometryType = (String) map.get("geometryType");
        } else {
            target = Geometry.class;
            geometryType = "Geometry";
        }

        return getStoreWriter(f.getFeatureType(), writers, multiWriter, target, geometryType);
    }

