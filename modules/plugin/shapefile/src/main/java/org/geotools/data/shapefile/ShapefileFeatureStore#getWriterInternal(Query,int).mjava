    @Override
    protected FeatureWriter<SimpleFeatureType, SimpleFeature> getWriterInternal(Query query,
            int flags) throws IOException {
        if (flags == 0) {
            throw new IllegalArgumentException("no write flags set");
        }

        ShapefileFeatureReader reader = (ShapefileFeatureReader) delegate
                .getReaderInternal(Query.ALL);
        ShapefileFeatureWriter writer;
        ShapefileDataStore ds = getDataStore();
        if(ds.indexManager.hasFidIndex(false) || ds.isFidIndexed() && ds.indexManager.hasFidIndex(true)) {
            writer = new IndexedShapefileFeatureWriter(ds.indexManager, reader, ds.getCharset(), ds.getTimeZone());
        } else {
            writer = new ShapefileFeatureWriter(delegate.shpFiles, reader, ds.getCharset(), 
                    ds.getTimeZone());
        }
        writer.setMaxShpSize(getDataStore().getMaxShpSize());
        writer.setMaxDbfSize(getDataStore().getMaxDbfSize());

        // if we only have to add move to the end.
        // TODO: just make the code transfer the bytes in bulk instead and start actual writing at
        // the end
        if ((flags | WRITER_ADD) == WRITER_ADD) {
            while (writer.hasNext()) {
                writer.next();
            }
        }

        // if we are filtering wrap the writer so that it returns only the selected features
        // but writes down the mall
        Filter filter = query.getFilter();
        if (filter != null && !Filter.INCLUDE.equals(filter)) {
            return new FilteringFeatureWriter(writer, filter);
        } else {
            return writer;
        }
    }

