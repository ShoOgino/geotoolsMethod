    private MemoryNode cloneAndTranslate(Node node, IndexFile indexfile) throws IOException {
        // copy the shape ids and clean up
        node.pack();
        int[] shapeIds = node.getShapesId();
        int start = -1;
        int end = -1;
        if (shapeIds != null && shapeIds.length > 0) {
            start = offsets.size();
            // turn the shape ids into offsets so that we won't need to open the index file anymore
            for (int i = 0; i < shapeIds.length; i++) {
                offsets.add(indexfile.getOffsetInBytes(shapeIds[i]));
            }
            end = offsets.size();
        }
        node.clean();

        // recurse and then clean up the subnodes as well
        MemoryNode mem = new MemoryNode(node.getBounds(), start, end, node.getNumSubNodes());
        for (int i = 0; i < node.getNumSubNodes(); i++) {
            mem.subnodes[i] = cloneAndTranslate(node.getSubNode(i), indexfile);
        }
        node.clearSubNodes();

        return mem;
    }

