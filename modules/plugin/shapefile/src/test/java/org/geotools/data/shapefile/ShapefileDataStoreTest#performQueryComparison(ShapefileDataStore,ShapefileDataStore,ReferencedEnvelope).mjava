    private ArrayList<SimpleFeature> performQueryComparison(
            ShapefileDataStore indexedDS,
            ShapefileDataStore baselineDS,
            ReferencedEnvelope newBounds)
            throws FactoryRegistryException, IllegalFilterException, IOException {
        FilterFactory2 fac = CommonFactoryFinder.getFilterFactory2(null);
        String geometryName = indexedDS.getSchema().getGeometryDescriptor().getLocalName();

        Filter filter = fac.bbox(fac.property(geometryName), newBounds);

        SimpleFeatureCollection features = indexedDS.getFeatureSource().getFeatures(filter);
        SimpleFeatureCollection features2 = baselineDS.getFeatureSource().getFeatures(filter);

        ArrayList<SimpleFeature> baselineFeatures = new ArrayList<>();
        ArrayList<SimpleFeature> indexedFeatures = new ArrayList<>();

        try (SimpleFeatureIterator baselineIter = features2.features();
                SimpleFeatureIterator indexIter = features.features()) {
            while (baselineIter.hasNext()) {
                baselineFeatures.add(baselineIter.next());
            }
            while (indexIter.hasNext()) {
                indexedFeatures.add(indexIter.next());
            }
            assertFalse(indexIter.hasNext());
            assertFalse(baselineIter.hasNext());
            assertEquals(baselineFeatures.size(), indexedFeatures.size());
            for (SimpleFeature f : baselineFeatures) {
                assertTrue(
                        f.getID() + ((Geometry) f.getDefaultGeometry()).getEnvelopeInternal(),
                        indexedFeatures.contains(f));
            }
        }
        return indexedFeatures;
    }

