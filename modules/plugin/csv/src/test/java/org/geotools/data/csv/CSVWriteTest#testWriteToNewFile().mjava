    @Test
    public void testWriteToNewFile() throws IOException {
        File f = File.createTempFile("does-not-exist", ".csv");
        URL states = TestData.url("shapes/statepop.shp");
        FileDataStore store = FileDataStoreFinder.getDataStore(states);
        assertNotNull("couldn't create input store", store);
        CSVDataStoreFactory csvDataStoreFactory = new CSVDataStoreFactory();

        CSVDataStore datastore = (CSVDataStore) csvDataStoreFactory.createDataStoreFromFile(f);

        SimpleFeatureType featureType = store.getSchema();

        datastore.createSchema(featureType);
        SimpleFeatureSource source = datastore.getFeatureSource();
        if (source instanceof SimpleFeatureStore) {
            SimpleFeatureStore outStore = (SimpleFeatureStore) source;
            outStore.addFeatures(store.getFeatureSource().getFeatures());
        } else {
            fail("Can't write to new CSVDatastore");
        }

        datastore.dispose();
        datastore = (CSVDataStore) csvDataStoreFactory.createDataStoreFromFile(f);
        source = datastore.getFeatureSource();
        SimpleFeatureCollection features = source.getFeatures();
        assertEquals(
                "wrong number of records",
                store.getFeatureSource().getFeatures().size(),
                features.size());
    }

