    @Override
    protected ReferencedEnvelope getBoundsInternal(Query query) throws IOException {
        CoordinateReferenceSystem crs = getSchema().getCoordinateReferenceSystem();

        // we need to know how much we can translate of the filter (the translator will also
        // simplify the filter)
        OGRFilterTranslator filterTx = new OGRFilterTranslator(getSchema(), query.getFilter());
        if (Filter.EXCLUDE.equals(filterTx.getFilter())) {
            // empty results
            return new ReferencedEnvelope(crs);
        } else if (!filterTx.isFilterFullySupported()) {
            return null;
        } else {
            // encodable, we then encode and get the bounds
            Object dataSource = null;
            Object layer = null;

            try {
                // grab the layer
                String typeName = getEntry().getTypeName();
                dataSource = getDataStore().openOGRDataSource(false);
                layer = getDataStore().openOGRLayer(dataSource, typeName);

                // filter it
                setLayerFilters(layer, filterTx);

                Object extent = ogr.LayerGetExtent(layer);
                if (extent == null) {
                    return null;
                }
                return ogr.toEnvelope(extent, crs);

            } finally {
                if (layer != null) {
                    ogr.LayerRelease(layer);
                }
                if (dataSource != null) {
                    ogr.DataSourceRelease(dataSource);
                }
            }
        }
    }

