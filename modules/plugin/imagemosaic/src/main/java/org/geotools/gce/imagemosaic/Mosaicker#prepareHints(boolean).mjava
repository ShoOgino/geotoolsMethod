    /**
     * @return
     * @param useFinalImageLayout whether the layout should be created from the requested bounds or
     *     no layout should be provided
     */
    private RenderingHints prepareHints(boolean useFinalImageLayout) {
        final RenderingHints localHints = new RenderingHints(null);

        if (useFinalImageLayout) {
            // build final layout and use it for cropping purposes
            final ImageLayout layout =
                    new ImageLayout(
                            rasterLayerResponse.getRasterBounds().x,
                            rasterLayerResponse.getRasterBounds().y,
                            rasterLayerResponse.getRasterBounds().width,
                            rasterLayerResponse.getRasterBounds().height);
            Dimension tileDimensions = rasterLayerResponse.getRequest().getTileDimensions();
            if (tileDimensions == null) {
                tileDimensions = (Dimension) JAI.getDefaultTileSize().clone();
            }
            layout.setTileGridXOffset(0).setTileGridYOffset(0);
            layout.setTileHeight(tileDimensions.height).setTileWidth(tileDimensions.width);

            localHints.add(new RenderingHints(JAI.KEY_IMAGE_LAYOUT, layout));
        }

        // look for additional hints for caching and tile scheduling
        Hints responseHints = rasterLayerResponse.getHints();
        if (responseHints != null && !responseHints.isEmpty()) {

            // BorderExtender
            localHints.add(ImageUtilities.BORDER_EXTENDER_HINTS); // default
            BorderExtender be = Utils.getBorderExtenderHint(responseHints);
            if (be != null) {
                localHints.add(new RenderingHints(JAI.KEY_BORDER_EXTENDER, be));
            }

            Hints jaiHints = Utils.setupJAIHints(responseHints);
            if (jaiHints != null && !jaiHints.isEmpty()) {
                localHints.add(jaiHints);
            }
        }
        if (rasterLayerResponse.getGeometryMask() != null
                && rasterLayerResponse.isSetRoiProperty()) {
            localHints.add(new RenderingHints(ImageWorker.FORCE_MOSAIC_ROI_PROPERTY, true));
        }
        return localHints;
    }

