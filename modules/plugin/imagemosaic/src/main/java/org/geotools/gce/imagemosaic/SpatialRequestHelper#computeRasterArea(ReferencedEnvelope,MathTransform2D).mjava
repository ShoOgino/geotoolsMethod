    private Rectangle computeRasterArea(
            ReferencedEnvelope computedBBox, MathTransform2D requestedWorldToGrid)
            throws TransformException, FactoryException {
        final ReferencedEnvelope cropBBOXInRequestCRS =
                Utils.reprojectEnvelope(computedBBox, requestCRS, requestedBBox);
        // make sure it falls within the requested envelope
        cropBBOXInRequestCRS.intersection((com.vividsolutions.jts.geom.Envelope) requestedBBox);

        // now go back to raster space
        Rectangle computedRasterArea =
                new GeneralGridEnvelope(
                                CRS.transform(requestedWorldToGrid, cropBBOXInRequestCRS),
                                PixelInCell.CELL_CORNER,
                                false)
                        .toRectangle();
        // intersect with the original requested raster space to be sure that we stay within
        // the requested raster area
        XRectangle2D.intersect(computedRasterArea, requestedRasterArea, computedRasterArea);
        return computedRasterArea;
    }

