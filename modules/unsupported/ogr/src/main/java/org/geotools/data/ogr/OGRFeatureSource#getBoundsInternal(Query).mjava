    @Override
    protected ReferencedEnvelope getBoundsInternal(Query query) throws IOException {
        CoordinateReferenceSystem crs = getSchema().getCoordinateReferenceSystem();

        // we need to know how much we can translate of the filter (the translator will also
        // simplify the filter)
        OGRFilterTranslator filterTx = new OGRFilterTranslator(getSchema(), query.getFilter());
        if (Filter.EXCLUDE.equals(filterTx.getFilter())) {
            // empty results
            return new ReferencedEnvelope(crs);
        } else if (!filterTx.isFilterFullySupported()) {
            return null;
        } else {
            // encodable, we then encode and get the bounds
            Pointer dataSource = null;
            Pointer layer = null;

            try {
                // grab the layer
                String typeName = getEntry().getTypeName();
                dataSource = getDataStore().openOGRDataSource(false);
                layer = getDataStore().openOGRLayer(dataSource, typeName);

                // filter it
                setLayerFilters(layer, filterTx);

                Pointer<OGREnvelope> boundsPtr = allocate(OGREnvelope.class);
                int code = OGR_L_GetExtent(layer, boundsPtr, 0);
                if (code == OGRERR_FAILURE) {
                    return null;
                } else {
                    OGREnvelope bounds = boundsPtr.get();
                    return new ReferencedEnvelope(bounds.MinX(), bounds.MaxX(), bounds.MinY(),
                            bounds.MaxY(), crs);
                }
            } finally {
                OGRUtils.releaseLayer(layer);
                OGRUtils.releaseDataSource(dataSource);
            }
        }
    }

