    public FeatureReader<SimpleFeatureType, SimpleFeature> getFeatureReader(
            final Query query, final Transaction transaction, final SimpleFeatureType featureType)
            throws IOException {
        Filter filter = query.getFilter();
        if (filter == Filter.EXCLUDE || filter.equals(Filter.EXCLUDE)) {
            return new EmptyFeatureReader<>(featureType);
        }

        final String typeName = query.getTypeName();
        ArcSdeVersionHandler versionHandler = getVersionHandler(typeName, transaction);
        ISession session = getSession(transaction);

        FeatureReader<SimpleFeatureType, SimpleFeature> reader;
        try {
            reader = getFeatureReader(query, featureType, session, versionHandler);
        } catch (IOException | RuntimeException ioe) {
            session.dispose();
            throw ioe;
        }
        return reader;
    }

