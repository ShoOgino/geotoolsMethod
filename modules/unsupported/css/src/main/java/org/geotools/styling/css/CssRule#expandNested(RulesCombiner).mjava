    /**
     * Turns a rule with nested subrules into a flat list of rules (this rule, plus all nested with
     * a properly combined selector and property inheritance)
     * @return
     */
    public List<CssRule> expandNested(RulesCombiner combiner) {
        if (nestedRules.isEmpty()) {
            return Collections.singletonList(this);
        } else {
            Stream<CssRule> nestedRulesStream = nestedRules.stream().flatMap(r -> {
                return r.expandNested(combiner).stream().map(sr -> { 
                    CssRule combined = combiner.combineRules(Arrays.asList(this, sr));
                    combined.setComment(sr.getComment());
                    combined.setAncestry(null);
                    return combined;
                });
            });
            return Stream.concat(Stream.of(this), nestedRulesStream).collect(Collectors.toList());
        }
    }

