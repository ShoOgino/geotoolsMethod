    /**
     * Implementation that generates the total bounds (many file formats record this information in
     * the header)
     */
    protected ReferencedEnvelope getBoundsInternal(Query query) throws IOException {
        CoordinateReferenceSystem crs = this.featureType.getCoordinateReferenceSystem();
        ReferencedEnvelope bounds = null;

        try (FeatureReader<SimpleFeatureType, SimpleFeature> rdr = this.getReader()) {
            while (rdr.hasNext()) {
                SimpleFeature feature = rdr.next();

                if (feature != null) {

                    BoundingBox bb = feature.getBounds();

                    if (bounds == null) bounds = new ReferencedEnvelope(bb);
                    else bounds.expandToInclude(ReferencedEnvelope.reference(bb));
                }
            }
        }

        if (bounds == null) {
            bounds = ReferencedEnvelope.create(crs);
        }

        return bounds;
    }

