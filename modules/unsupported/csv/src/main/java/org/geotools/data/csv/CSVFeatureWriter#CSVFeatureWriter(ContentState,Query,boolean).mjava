    public CSVFeatureWriter(ContentState state, Query query, boolean append) throws IOException {
        this.state = state;

        String typeName = query.getTypeName();
        File file = ((CSVDataStore) state.getEntry().getDataStore()).file;
        File directory = file.getParentFile();
        this.temp = File.createTempFile(typeName + System.currentTimeMillis(), "csv", directory);
        this.csvWriter = new CsvWriter(new FileWriter(this.temp), ',');
        if (append) {
            Files.copy(file.toPath(), temp.toPath(), StandardCopyOption.REPLACE_EXISTING );
            // skip through the contents to the end
//            this.copying = true;
//            try {
//                while (reader.hasNext()) {
//                    this.currentFeature = reader.next();
//                    this.write();
//                }
//            }
//            finally {
//                this.copying = false;
//            }
        }
        else {
            this.delegate = new CSVFeatureReader(state,query);
            this.csvWriter.writeRecord(delegate.reader.getHeaders());
        }
        this.appending = append;
    }

