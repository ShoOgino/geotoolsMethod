    void fixupProperties(Query q, SimpleFeatureType featureType, Set<String> sourceNames) {
        if (q.getPropertyNames() != null) {
            if (q.getPropertyNames().length > 0) {
                // some specific property was asked for, let's filter them
                List<String> filtered = new ArrayList<String>();
                for (String name : q.getPropertyNames()) {
                    if (sourceNames.contains(name)) {
                        filtered.add(name);
                    }
                }
                String[] filteredArray = (String[]) filtered.toArray(new String[filtered.size()]);
                q.setPropertyNames(filteredArray);
            }
        } else {
            // all attributed were asked for, let's stick to the intersection between
            // target and source then
            List<String> filtered = new ArrayList<String>();
            for (String name : sourceNames) {
                if (featureType.getDescriptor(name) != null) {
                    filtered.add(name);
                }
            }
            String[] filteredArray = (String[]) filtered.toArray(new String[filtered.size()]);
            q.setPropertyNames(filteredArray);
        }
    }

