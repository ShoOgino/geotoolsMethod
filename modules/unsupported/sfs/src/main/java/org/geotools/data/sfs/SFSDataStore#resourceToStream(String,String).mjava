    /**
     * This method requests the response from the URL either through GET/POST
     * and returns the response as a stream
     * The request is going to be a POST one if postData is not null, a GET otherwise
     * @param is
     * @return String
     * @throws IOException
     */
    InputStream resourceToStream(String resource, String postData) throws MalformedURLException,
            IOException, ProtocolException {
        // TODO: use commons http client + persistent connections instead
        URL url = new URL(baseURL + resource);
        HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();
        urlConnection.setRequestProperty("Accept-Encoding", "gzip");
        
        // if we have username/password use them to setup basic auth
        if(user != null && password != null) {
            String combined = nullToEmpty(user) + ":" + nullToEmpty(password);
            byte[] authBytes = combined.getBytes("US-ASCII");
            String encoded = new String(Base64.encodeBase64(authBytes));
            urlConnection.setRequestProperty("Authorization",  "Basic " + encoded);
        }
        
        // enforce the timeout if we have one
        if(timeout > 0) {
            urlConnection.setConnectTimeout(timeout);
            urlConnection.setReadTimeout(timeout);
        }
        
        urlConnection.setDoInput(true);
        if(postData != null && !"".equals(postData.trim())) {
            urlConnection.setRequestMethod("POST");
            urlConnection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
            urlConnection.setDoOutput(true);
            
            /*write the data to server*/
            OutputStreamWriter wr = null;
            try {
                wr = new OutputStreamWriter(urlConnection.getOutputStream());
                wr.write(postData);
                wr.flush();
            } finally {
                if(wr != null) {
                    wr.close();
                }
            }
        } else {
            urlConnection.setRequestMethod("GET");
        }
        
        /* Get the response from the server*/
        if(urlConnection.getResponseCode() != 200) {
            throw new IOException("Server reported and error with code " + 
                    urlConnection.getResponseCode() + ": " + urlConnection.getResponseMessage() + " accessing resource " + url.toExternalForm());
        } else {
            InputStream is = urlConnection.getInputStream();
            String encoding = urlConnection.getContentEncoding();
            if ("gzip".equalsIgnoreCase(encoding)) {
                is = new GZIPInputStream(is);
            }
            
            return is;
        }
    }

