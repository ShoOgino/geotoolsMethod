    @Test
    public void testSimplifyFilter() throws Exception {
        if (url == null)
            return;
        Map m = new HashMap();
        m.put(WFSDataStoreFactory.URL.key, url);
        m.put(WFSDataStoreFactory.TIMEOUT.key, new Integer(100000));
        WFS_1_0_0_DataStore wfs = (WFS_1_0_0_DataStore) (new WFSDataStoreFactory())
                .createDataStore(m);
        FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2(GeoTools.getDefaultHints());

        WFSFeatureSource fs = wfs.getFeatureSource("topp:states");
        
        // build a filter with bits that cannot be encoded in OGC filter, but can be simplified
        // to one that can
        Filter f = ff.or(Arrays.asList(Filter.EXCLUDE, ff.and(Filter.INCLUDE, ff.greater(ff.property("PERSONS"), ff.literal(10000000)))));
        SimpleFeatureCollection fc = fs.getFeatures(f);
        
        // force calling a HITS query, it used to throw an exception
        int size = fc.size();
        
        // force making a GetFeature, it used to blow up
        SimpleFeatureIterator fi = null;
        try {
            fi = fc.features();
            if(fi.hasNext()) {
                fi.next();
            }
        } finally {
            if(fi != null) {
                fi.close();
            }
        }
    }

