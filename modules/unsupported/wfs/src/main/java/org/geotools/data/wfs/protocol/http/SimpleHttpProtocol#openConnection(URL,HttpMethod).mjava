    private HttpURLConnection openConnection(URL targetUrl, HttpMethod method) throws IOException {
        HttpURLConnection conn;
        try {
            conn = (HttpURLConnection) targetUrl.openConnection();
        } catch (ClassCastException wrongUrl) {
            throw new IOException("HTTP connection required for " + targetUrl);
        }
        if (0 < getTimeoutMillis()) {
            conn.setConnectTimeout(getTimeoutMillis());
            conn.setReadTimeout(getTimeoutMillis());
        }
        // remember to set the Accept-Encoding header before setting the authentication credentials
        // or an IllegalStateException is thrown
        if (isTryGzip()) {
            conn.setRequestProperty("Accept-Encoding", "gzip");
        }
        if (method == HttpMethod.POST) {
            conn.setRequestMethod("POST");
            // conn.setRequestProperty("Content-type", "text/xml, application/xml");
            conn.setDoOutput(true);
        } else {
            conn.setRequestMethod("GET");
        }
        conn.setDoInput(true);

        if (authUsername != null && authPassword != null) {
            String userPassword = authUsername + ":" + authPassword;
            byte[] encodedUserPassword = userPassword.getBytes();

            String base64UserAndPasswd = new String(Base64.encodeBase64(encodedUserPassword));
            
            conn.setRequestProperty("Authorization", "Basic " + base64UserAndPasswd);
        }

        return conn;
    }

