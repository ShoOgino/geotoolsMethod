    private Query reprojectFilter(Query query) throws IOException {
        final Filter originalFilter = query.getFilter() != null ? query
                .getFilter() : Filter.INCLUDE;
        if (Filter.INCLUDE.equals(originalFilter)) {
            return query;
        }

        final SimpleFeatureType nativeFeatureType = getSchema();
        final GeometryDescriptor geom = nativeFeatureType
                .getGeometryDescriptor();
        // if no geometry involved, no reprojection needed
        if (geom == null) {
            return query;
        }

        final FilterFactory2 ff = CommonFactoryFinder.getFilterFactory2(null);

        try {
            CoordinateReferenceSystem nativeCRS = geom
                    .getCoordinateReferenceSystem();

            // now we apply a default to all geometries and bbox in the filter
            DefaultCRSFilterVisitor defaultCRSVisitor = new DefaultCRSFilterVisitor(
                    ff, nativeCRS);
            final Filter defaultedFilter = (Filter) originalFilter.accept(
                    defaultCRSVisitor, null);

            // and then we reproject all geometries so that the datastore
            // receives
            // them in the native projection system (or the forced one, in case
            // of force)
            ReprojectingFilterVisitor reprojectingVisitor = new ReprojectingFilterVisitor(
                    ff, nativeFeatureType);
            final Filter reprojectedFilter = (Filter) defaultedFilter.accept(
                    reprojectingVisitor, null);

            Query reprojectedQuery = new Query(query);
            reprojectedQuery.setFilter(reprojectedFilter);
            return reprojectedQuery;
        } catch (Exception e) {
            throw new DataSourceException(
                    "Had troubles handling filter reprojection...", e);
        }
    }

