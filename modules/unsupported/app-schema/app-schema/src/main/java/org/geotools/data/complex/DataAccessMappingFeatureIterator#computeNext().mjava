    protected Feature computeNext() throws IOException {
        if (curSrcFeature == null) {
            throw new UnsupportedOperationException("No features found in next()."
                    + "This wouldn't have happenned if hasNext() was called beforehand.");
        }

        setHasNextCalled(false);

        ArrayList<Feature> sources = new ArrayList<Feature>();

        String id = extractIdForFeature(curSrcFeature);

        if (isFiltered) {
            setNextFilteredFeature(id, sources);
        } else {
            setNextFeature(id, sources);
        }
        final AttributeDescriptor targetNode = mapping.getTargetFeature();
        final Name targetNodeName = targetNode.getName();
        
        AttributeBuilder builder = new AttributeBuilder(attf);
        builder.setDescriptor(targetNode);
        Feature target = (Feature) builder.build(id);

        for (AttributeMapping attMapping : selectedMapping) { 
            try {
                if (isTopLevelmapping(targetNodeName, attMapping.getTargetXPath())) {
                    // ignore the top level mapping for the Feature itself
                    // as it was already set
                    continue;
                }
                
                // extract the values from multiple source features of the same id
                // and set them to one built feature
                if (attMapping.isMultiValued()) {
                    for (Feature source : sources) {
                        setAttributeValue(target, source, attMapping, null, null, selectedProperties.get(attMapping));
                    }
                } else {
                    setAttributeValue(target, sources.get(0), attMapping, null, null, selectedProperties.get(attMapping));
                }
            } catch (Exception e) {
                throw new RuntimeException("Error applying mapping with targetAttribute "
                        + attMapping.getTargetXPath(), e);    
            }                
        }       
        return target;
    }

