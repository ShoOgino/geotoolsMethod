    /**
     * Create a FeatureWriter for the given type name.
     * 
     * @param typeName
     *                The typeName of the FeatureType to write
     * @param transaction
     *                DOCUMENT ME!
     * 
     * @return A new FeatureWriter.
     * 
     * @throws IOException
     *                 If the typeName is not available or some other error
     *                 occurs.
     */
    protected FeatureWriter<SimpleFeatureType, SimpleFeature> createFeatureWriter(String typeName,
            Transaction transaction) throws IOException {
        typeCheck(typeName);
        
        // when writing we may remove features, in order to prevent fid changes we'll need
        // a .fix file
        existsOrCreateFidIndex();

        FeatureReader<SimpleFeatureType, SimpleFeature> featureReader;
        IndexedShapefileAttributeReader attReader;
        try {
            SimpleFeatureType schema = getSchema();
            if (schema == null) {
                throw new IOException(
                        "To create a shapefile, you must first call createSchema()");
            }
            attReader = getAttributesReader(true, true, null, schema);
            featureReader = createFeatureReader(typeName, attReader, schema);

        } catch (Exception e) {
            attReader = getAttributesReader(true, true, null, schema);
            featureReader = new EmptyFeatureReader<SimpleFeatureType, SimpleFeature>(schema);
        }
        
        if(featureReader == null) {
            return new EmptyFeatureWriter(schema);
        }

        return new IndexedShapefileFeatureWriter(typeName, shpFiles, attReader,
                featureReader, this, dbfCharset, dbfTimeZone);
    }

