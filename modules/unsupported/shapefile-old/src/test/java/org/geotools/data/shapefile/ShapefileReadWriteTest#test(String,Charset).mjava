    private void test(String f, Charset charset) throws Exception {
        copyShapefiles(f); // Work on File rather than URL from JAR.
        ShapefileDataStore s = null;
        if(charset == null) {
            s = new ShapefileDataStore(TestData.url(TestCaseSupport.class, f));
        } else {
            s = new ShapefileDataStore(TestData.url(TestCaseSupport.class, f), false, charset);
        }
        String typeName = s.getTypeNames()[0];
        SimpleFeatureSource source = s.getFeatureSource(typeName);
        SimpleFeatureType type = source.getSchema();
        SimpleFeatureCollection one = source.getFeatures();
        File tmp = getTempFile();

        ShapefileDataStoreFactory maker = new ShapefileDataStoreFactory();
        test(type, one, tmp, maker, true, charset);

        File tmp2 = getTempFile(); // TODO consider reuse tmp results in
        // failure
        test(type, one, tmp2, maker, false, charset);
        s.dispose();
    }

