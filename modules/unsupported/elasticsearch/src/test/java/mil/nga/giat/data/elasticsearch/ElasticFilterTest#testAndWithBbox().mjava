    @Test
    public void testAndWithBbox() throws IOException {
        And filter = ff.and(ff.id(ff.featureId("id1")), ff.bbox("geom", 0., 0., 1.1, 1.1, "EPSG:4326"));
        List<List<Double>> coords = new ArrayList<>();
        coords.add(ImmutableList.of(0.,0.));
        coords.add(ImmutableList.of(0.,1.1));
        coords.add(ImmutableList.of(1.1,1.1));
        coords.add(ImmutableList.of(1.1,0.));
        coords.add(ImmutableList.of(0.,0.));
        Map<String,Object> expected = ImmutableMap.of("bool", ImmutableMap.of("must", ImmutableList.of(
                ImmutableMap.of("ids", ImmutableMap.of("values", ImmutableList.of("id1"))), ImmutableMap.of("bool", 
                        ImmutableMap.of("must", MATCH_ALL, "filter", ImmutableMap.of("geo_shape", ImmutableMap.of("geom", ImmutableMap.of("shape", 
                                ImmutableMap.of("coordinates", ImmutableList.of(coords), "type", "Polygon"),
                                "relation", "INTERSECTS")))
                                )))));

        builder.visit(filter, null);
        assertTrue(builder.createCapabilities().fullySupports(filter));
        assertEquals(expected.toString(), builder.getQueryBuilder().toString());
    }

