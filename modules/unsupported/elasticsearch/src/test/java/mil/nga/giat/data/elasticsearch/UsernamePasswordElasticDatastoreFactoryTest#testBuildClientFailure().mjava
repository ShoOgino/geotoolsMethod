    @Test
    public void testBuildClientFailure() throws IOException {
        when(statusLine.getStatusCode()).thenReturn(400);
        Mockito.doAnswer(new Answer() {
            private int count = 0;

            @Override
            public Object answer(InvocationOnMock invocation) throws Throwable {
                count++;
                if (count > 1) {
                    throw new IOException("close fail");
                }
                return null;
            }
        }).when(restClient).close();
        try {
            dataStoreFactory.createDataStore(params);
            fail();
        } catch (IOException e) {
            assertEquals(0, dataStoreFactory.getClients().size());
            // admin client with retry
            verify(clientBuilder, times(2)).build();
            verify(restClient, times(2)).close();
        }
    }

