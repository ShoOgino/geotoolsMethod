    @Test
    public void testBuckets() throws IOException {
        ElasticAggregation aggregation = new ElasticAggregation();
        aggregation.setBuckets(new ArrayList<>());
        aggregations.put("test", aggregation);
        assertFalse((new ElasticFeatureReader(state, hits, aggregations, 0)).hasNext());

        aggregation.setBuckets(ImmutableList.of(ImmutableMap.of("key1","value1"), ImmutableMap.of("key2","value2")));
        reader = new ElasticFeatureReader(state, hits, aggregations, 0);
        assertTrue(reader.hasNext());
        feature = reader.next();
        assertNotNull(feature.getAttribute("_aggregation"));
        assertEquals(ImmutableSet.of("key1"), byteArrayToMap(feature.getAttribute("_aggregation")).keySet());
        assertTrue(reader.hasNext());
        feature = reader.next();
        assertNotNull(feature.getAttribute("_aggregation"));
        assertEquals(ImmutableSet.of("key2"), byteArrayToMap(feature.getAttribute("_aggregation")).keySet());
        assertFalse(reader.hasNext());
    }

