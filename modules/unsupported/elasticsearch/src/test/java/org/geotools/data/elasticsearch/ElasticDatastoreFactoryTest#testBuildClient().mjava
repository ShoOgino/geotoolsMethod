    @Test
    public void testBuildClient() throws IOException {
        assertNotNull(dataStoreFactory.createDataStore(params));
        verify(clientBuilder, times(2)).build();
        assertEquals(1, hostsCaptor.getValue().length);
        assertEquals("localhost", hostsCaptor.getValue()[0].getHostName());
        assertEquals(9200, hostsCaptor.getValue()[0].getPort());

        assertEquals(2, configCallbackCaptor.getAllValues().size());
        configCallbackCaptor.getAllValues().get(0).customizeHttpClient(httpClientBuilder);
        Credentials credentials =
                credentialsProviderCaptor
                        .getValue()
                        .getCredentials(new AuthScope("localhost", 9200));
        assertNotNull(credentials);
        assertEquals("admin", credentials.getUserPrincipal().getName());
        assertEquals("admin", credentials.getPassword());
        configCallbackCaptor.getAllValues().get(1).customizeHttpClient(httpClientBuilder);
        Credentials proxyCredentials =
                credentialsProviderCaptor
                        .getValue()
                        .getCredentials(new AuthScope("localhost", 9200));
        assertNotNull(proxyCredentials);
        assertEquals("proxy", proxyCredentials.getUserPrincipal().getName());
        assertEquals("proxy", proxyCredentials.getPassword());

        assertEquals(2, threadFactoryCaptor.getAllValues().size());
        ThreadFactory threadFactory = threadFactoryCaptor.getAllValues().get(0);
        Thread thread = threadFactory.newThread(mock(Runnable.class));
        assertEquals("esrest-asynchttp-ADMIN-1", thread.getName());
        ThreadFactory proxyThreadFactory = threadFactoryCaptor.getAllValues().get(1);
        Thread proxyThread = proxyThreadFactory.newThread(mock(Runnable.class));
        assertEquals("esrest-asynchttp-PROXY_USER-2", proxyThread.getName());

        assertNotNull(
                requestConfigCallbackCaptor
                        .getValue()
                        .customizeRequestConfig(requestConfigBuilder));
    }

