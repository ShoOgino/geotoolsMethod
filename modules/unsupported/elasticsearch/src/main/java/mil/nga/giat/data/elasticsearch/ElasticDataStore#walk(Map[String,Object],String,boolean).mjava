    private void walk(Map<String,Object> map, String propertyKey, boolean startType) {
        for (final Map.Entry<String, Object> entry : map.entrySet()) {
            final String key = entry.getKey();
            final Object value = entry.getValue();
            if (!key.equals("_timestamp") && Map.class.isAssignableFrom(value.getClass())) {
                final String newPropertyKey;
                if (!startType && key.equals("properties")) {
                    newPropertyKey = propertyKey;
                } else if (propertyKey.isEmpty()) {
                    newPropertyKey = entry.getKey();
                } else {
                    newPropertyKey = propertyKey + "." + key;
                }
                startType = !startType && key.equals("properties");
                walk((Map) value, newPropertyKey, startType);
            } else if (key.equals("type")) {
                add(propertyKey, (String) value, map);
            } else if (key.equals("_timestamp")) {
                add("_timestamp", "date", map);
            }
        }
    }

