    private void updateGrid(double lat, double lon, Number value) {
        final int row = grid.length-(int) Math.round((lat-envelope.getMinY())/cellHeight)-1;
        final int col = (int) Math.round((lon-envelope.getMinX())/cellWidth);
        grid[Math.min(row,grid.length-1)][Math.min(col,grid[0].length-1)] = scale.scaleValue(value.floatValue());
    }

