    protected void visitDistanceSpatialOperator(DistanceBufferOperator filter,
            PropertyName property, Literal geometry, boolean swapped,
            Object extraData) {

        property.accept(delegate, extraData);
        key = (String) delegate.field;
        geometry.accept(delegate, extraData);
        final Geometry geo = delegate.currentGeometry;
        lat = geo.getCentroid().getY();
        lon = geo.getCentroid().getX();
        final double inputDistance = filter.getDistance();
        final String inputUnits = filter.getDistanceUnits();
        distance = Double.valueOf(toMeters(inputDistance, inputUnits));

        delegate.queryBuilder = ImmutableMap.of("bool", ImmutableMap.of("must", MATCH_ALL,
                "filter", ImmutableMap.of("geo_distance", 
                        ImmutableMap.of("distance", distance+"m", key, ImmutableList.of(lon,lat)))));

        if ((filter instanceof DWithin && swapped)
                || (filter instanceof Beyond && !swapped)) {
            delegate.queryBuilder = ImmutableMap.of("bool", ImmutableMap.of("must_not", delegate.queryBuilder));
        }
    }

