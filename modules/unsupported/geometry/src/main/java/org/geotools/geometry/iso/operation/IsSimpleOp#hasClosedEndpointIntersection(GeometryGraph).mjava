    /**
     * Test that no edge intersection is the endpoint of a closed line. To check this we compute the
     * degree of each endpoint. The degree of endpoints of closed lines must be exactly 2.
     */
    private boolean hasClosedEndpointIntersection(GeometryGraph graph) {
        Map endPoints = new TreeMap();
        for (Iterator i = graph.getEdgeIterator(); i.hasNext(); ) {
            Edge e = (Edge) i.next();
            boolean isClosed = e.isClosed();
            Coordinate p0 = e.getCoordinate(0);
            addEndpoint(endPoints, p0, isClosed);
            Coordinate p1 = e.getCoordinate(e.getNumPoints() - 1);
            addEndpoint(endPoints, p1, isClosed);
        }

        for (Iterator i = endPoints.values().iterator(); i.hasNext(); ) {
            EndpointInfo eiInfo = (EndpointInfo) i.next();
            if (eiInfo.isClosed && eiInfo.degree != 2) return true;
        }
        return false;
    }

