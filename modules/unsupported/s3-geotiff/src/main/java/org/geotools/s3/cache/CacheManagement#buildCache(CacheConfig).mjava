    private static CacheManager buildCache(CacheConfig config) {
        CacheManager manager;
        if (config.getConfigurationPath() != null) {
            manager = CacheManager.newInstance(config.getConfigurationPath());
        }
        else {
            Configuration cacheConfig = new Configuration();
            cacheConfig.setMaxBytesLocalDisk((long) config.getDiskCacheSize());
            cacheConfig.setMaxBytesLocalHeap((long) config.getHeapSize());
            CacheConfiguration defaultCacheConfiguration = new CacheConfiguration()
                .persistence(new PersistenceConfiguration().strategy(
                    PersistenceConfiguration.Strategy.LOCALTEMPSWAP));
            cacheConfig.defaultCache(defaultCacheConfiguration);

            if (config.isUseDiskCache()) {
                DiskStoreConfiguration diskConfig = new DiskStoreConfiguration();
                diskConfig.setPath(config.getCacheDirectory().toAbsolutePath().toString());
                cacheConfig.diskStore(diskConfig);
            }
            
            manager = new CacheManager(cacheConfig);

            manager.addCache(DEFAULT_CACHE);
            Cache cache = manager.getCache(DEFAULT_CACHE);
            SelfPopulatingCache populatingCache = new SelfPopulatingCache(cache, new S3ChunkEntryFactory(config));
            manager.replaceCacheWithDecoratedCache(cache, populatingCache);
        }

        return manager;
    }

