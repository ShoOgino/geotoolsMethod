    /**
     * @throws IllegalStateException when the reader is configured for unsafe XML and this is not
     *     explicitly allowed by {@link #setUnsafeXMLAllowed setUnsafeXMLAllowed}.
     */
    private void checkUnsafeXML() throws IllegalStateException {
        if (!this.unsafeXMLAllowed) {
            // Only check whether DTDs are enabled because when DTDs are not supported, XXE and XML
            // bombs are not possible. Even if DTDs are enabled but external entities are disabled,
            // XML entity expansion and thus XML bombs are still possible.

            // StAX does not define properties to limit entity expansion or enable secure processing
            // such as JAXP.
            // A StAX implementation like Woodstox provides its' own properties to set limits, such
            // as P_MAX_ENTITY_DEPTH and others, which allows limited use of these XML features.
            // Call setUnsafeXMLAllowed(true) after making sure the XML you are parsing is safe or
            // the StAX parser is configured with appropriate limits if you really need DTD support.

            if (Boolean.TRUE.equals(reader.getProperty(XMLInputFactory.SUPPORT_DTD))) {
                throw new IllegalStateException(
                        "XMLStreamReader allows DTDs but "
                                + this.getClass().getSimpleName()
                                + " is not configured to allow unsafe XML");
            }
        }
    }

