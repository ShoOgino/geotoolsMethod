    /**
     * Writes the provided rendered image to the provided image output stream using the supplied
     * geotiff metadata.
     *
     * @param gtParams
     */
    private boolean writeImage(
            final RenderedImage image,
            final ImageOutputStream outputStream,
            final GeoTiffIIOMetadataEncoder geoTIFFMetadata,
            GeoToolsWriteParams gtParams)
            throws IOException {
        if (image == null || outputStream == null) {
            throw new NullPointerException("Some input parameters are null");
        }
        final ImageWriteParam params = gtParams.getAdaptee();
        if (params instanceof TIFFImageWriteParam && gtParams instanceof GeoTiffWriteParams) {
            final TIFFImageWriteParam param = (TIFFImageWriteParam) params;
            param.setForceToBigTIFF(((GeoTiffWriteParams) gtParams).isForceToBigTIFF());
        }
        //
        // GETTING READER AND METADATA
        //
        final ImageWriter writer = GeoTiffUtils.TIFFWRITERFACTORY.createWriterInstance();
        final IIOMetadata metadata =
                GeoTiffUtils.createGeoTiffIIOMetadata(
                        writer,
                        ImageTypeSpecifier.createFromRenderedImage(image),
                        geoTIFFMetadata,
                        params);

        try {

            //
            // IMAGEWRITE
            //
            writer.setOutput(outputStream);
            writer.write(
                    writer.getDefaultStreamMetadata(params),
                    new IIOImage(image, null, metadata),
                    params);

        } finally {
            //
            // release resources
            //
            try {
                if (outputStream != null) {
                    outputStream.flush();
                }
            } catch (Throwable e) {
                // eat me
            }

            try {
                if (!(destination instanceof ImageOutputStream) && outputStream != null) {
                    outputStream.close();
                }
            } catch (Throwable e) {
                // eat me
            }

            try {
                if (writer != null) {
                    writer.dispose();
                }
            } catch (Throwable e) {
                // eat me
            }
        }

        return true;
    }

