    @Test
    public void testFeatures() throws Exception {

        PowerMockito.mockStatic(HttpClients.class);
        PowerMockito.when(HttpClients.createDefault()).thenReturn(clientMock);

        PowerMockito.whenNew(HttpGet.class)
                .withNoArguments()
                .thenReturn(getMock)
                .thenReturn(getMock);
        when(clientMock.execute(getMock)).thenReturn(responseMock);
        when(responseMock.getStatusLine()).thenReturn(responseMockStatusLine);
        when(responseMockStatusLine.getStatusCode()).thenReturn(HttpStatus.SC_OK);
        when(responseMock.getEntity()).thenReturn(responseMockEntity);
        when(responseMockEntity.getContent())
                .thenReturn(
                        ArcGISRestDataStoreFactoryTest.readJSONAsStream("test-data/catalog.json"))
                .thenReturn(
                        ArcGISRestDataStoreFactoryTest.readJSONAsStream(
                                "test-data/lgaDataset.json"))
                .thenReturn(
                        ArcGISRestDataStoreFactoryTest.readJSONAsStream(
                                "test-data/lgaDataset.json"));

        this.dataStore =
                (ArcGISRestDataStore)
                        ArcGISRestDataStoreFactoryTest.createDefaultOpenDataTestDataStore();
        this.dataStore.createTypeNames();

        FeatureSource<SimpleFeatureType, SimpleFeature> src =
                this.dataStore.createFeatureSource(
                        this.dataStore.getEntry(
                                new NameImpl(ArcGISRestDataStoreFactoryTest.NAMESPACE, TYPENAME1)));
        src.getSchema();

        // Test feature iteration
        PowerMockito.whenNew(HttpPost.class).withNoArguments().thenReturn(this.postMock);
        when(this.clientMock.execute(postMock)).thenReturn(responseMock);
        when(responseMock.getStatusLine()).thenReturn(responseMockStatusLine);
        when(responseMockStatusLine.getStatusCode()).thenReturn(HttpStatus.SC_OK);
        when(responseMock.getEntity()).thenReturn(responseMockEntity);
        when(responseMockEntity.getContent())
                .thenReturn(
                        ArcGISRestDataStoreFactoryTest.readJSONAsStream(
                                "test-data/lgaFeatures.geo.json"));

        FeatureCollection<SimpleFeatureType, SimpleFeature> fc = src.getFeatures(new Query());
        FeatureIterator iter = fc.features();

        assertEquals(CRS.decode("EPSG:3857"), fc.getSchema().getCoordinateReferenceSystem());
        assertEquals(true, iter.hasNext());
        SimpleFeature sf = (SimpleFeature) iter.next();
        assertEquals(true, iter.hasNext());
        sf = (SimpleFeature) iter.next();
        assertEquals(
                "POINT (16421261.466298774 -4592239.022226746)",
                ((Geometry) (sf.getAttribute("geometry"))).getCentroid().toString());
        assertEquals("Wellington (S)", sf.getAttribute("LGA"));
        assertEquals(false, iter.hasNext());
        assertEquals(false, iter.hasNext());
    }

