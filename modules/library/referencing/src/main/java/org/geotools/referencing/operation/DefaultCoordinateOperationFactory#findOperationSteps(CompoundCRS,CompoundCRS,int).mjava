    /**
     * Returns all available operations between two compound coordinate reference systems.
     *
     * @param sourceCRS Input coordinate reference system.
     * @param targetCRS Output coordinate reference system.
     * @param limit The maximum number of operations to be returned. Use -1 to return all the available operations. Use 1 to return just one
     *        operations. Currently, the behavior for other values of {@code limit} is undefined.
     * @return A {@code Set} of coordinate operations from {@code sourceCRS} to {@code targetCRS}.
     * @throws FactoryException If the operation can't be constructed.
     */
    protected Set<CoordinateOperation> findOperationSteps(final CompoundCRS sourceCRS,
            final CompoundCRS targetCRS, int limit)
            throws FactoryException
    {
        final List<SingleCRS> sources = DefaultCompoundCRS.getSingleCRS(sourceCRS);
        final List<SingleCRS> targets = DefaultCompoundCRS.getSingleCRS(targetCRS);
        if (targets.size() == 1) {
            return findOperations(sourceCRS, targets.get(0), limit);
        }
        if (sources.size() == 1) { // After 'targets' because more likely to fails to transform.
            return findOperations(sources.get(0), targetCRS, limit);
        }
        /*
         * If the source CRS contains both a geodetic and a vertical CRS, then we can process
         * only if there is no datum change. If at least one of those CRS appears in the target
         * CRS with a different datum, then the datum shift must be applied on the horizontal and
         * vertical components together.
         */
        for (final SingleCRS target : targets) {
            if (needsGeodetic3D(sources, target)) {
                final ReferencingFactoryContainer factories = getFactoryContainer();
                final CoordinateReferenceSystem source3D = factories.toGeodetic3D(sourceCRS);
                final CoordinateReferenceSystem target3D = factories.toGeodetic3D(targetCRS);
                if (source3D!=sourceCRS || target3D!=targetCRS) {
                    return findOperations(source3D, target3D, limit);
                }
                /*
                 * TODO: Search for non-ellipsoidal height, and lets supplemental axis pass through.
                 *       See javadoc comments for createOperation(CompoundCRS, SingleCRS).
                 */
                return Collections.emptySet();
            }
        }
        // No need for a datum change (see 'needGeodetic3D' javadoc).
        return Collections
                .singleton(createOperationStep(sourceCRS, sources, targetCRS, targets));
    }

