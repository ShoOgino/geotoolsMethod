    /**
     * Returns an envelope that contains fully all the specified points. If the envelope can't be
     * calculated, then this method returns {@code null}.
     *
     * @param target {@code false} for the envelope of source points, or {@code true} for the
     *     envelope of target points.
     */
    private GeneralEnvelope getEnvelope(final boolean target) {
        GeneralEnvelope envelope = null;
        CoordinateReferenceSystem crs = null;
        for (final Iterator<MappedPosition> it = getMappedPositions().iterator(); it.hasNext(); ) {
            final MappedPosition mp = it.next();
            final DirectPosition point = target ? mp.getTarget() : mp.getSource();
            if (point != null) {
                if (envelope == null) {
                    final double[] coordinates = point.getCoordinate();
                    envelope = new GeneralEnvelope(coordinates, coordinates);
                } else {
                    envelope.add(point);
                }
                crs = getCoordinateReferenceSystem(point, crs);
            }
        }
        if (envelope != null) {
            envelope.setCoordinateReferenceSystem(crs);
        }
        return envelope;
    }

