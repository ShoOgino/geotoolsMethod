    /**
     * Checks we won't label a feature with an almost 90 degrees change in the last segment
     *
     * @throws Exception
     */
    public void testSharpChangeLastSegment() throws Exception {
        FeatureCollection collection = createSharpTurnLineCollection();
        Style style = loadStyle("LineStyleLarge.sld");
        assertNotNull(style);
        MapContext map = new DefaultMapContext(DefaultGeographicCRS.WGS84);
        map.addLayer(collection, style);

        StreamingRenderer renderer = new StreamingRenderer();
        renderer.setJava2DHints(new RenderingHints(KEY_ANTIALIASING, VALUE_ANTIALIAS_ON));
        renderer.setContext(map);
        int boundary = 2;
        ReferencedEnvelope env = map.getLayerBounds();
        env =
                new ReferencedEnvelope(
                        env.getMinX() - boundary,
                        env.getMaxX() + boundary,
                        env.getMinY() - boundary,
                        env.getMaxY() + boundary,
                        null);

        BufferedImage image = RendererBaseTest.showRender("Ell label", renderer, 1000, env);
        String refPath =
                "./src/test/resources/org/geotools/renderer/lite/test-data/lineLabelSharpTurnLastSegment.png";
        // small tolerance
        ImageAssert.assertEquals(new File(refPath), image, 100);
    }

