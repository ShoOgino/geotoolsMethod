    private void applyAndAssertContrastEnhancement(GridCoverage2DReader reader)
            throws TransformException, NoninvertibleTransformException, FactoryException,
                    IOException {
        ReferencedEnvelope mapExtent =
                new ReferencedEnvelope(0, 90, 0, 90, DefaultGeographicCRS.WGS84);
        GridCoverageRenderer renderer =
                new GridCoverageRenderer(
                        DefaultGeographicCRS.WGS84, mapExtent, new Rectangle(0, 0, 255, 255), null);

        int min = 10;
        int max = 100;
        RasterSymbolizer symbolizer = createClippingChannelSelectionSymbolizer(min, max);

        RenderedImage image =
                renderer.renderImage(
                        reader,
                        null,
                        symbolizer,
                        Interpolation.getInstance(Interpolation.INTERP_NEAREST),
                        Color.BLACK,
                        256,
                        256);
        assertEquals(3, image.getSampleModel().getNumBands());

        // Make sure clip occurred even with optimized band selection
        ImageWorker worker = new ImageWorker(image);

        double[] maximums = worker.getMaximums();
        assertEquals(max, maximums[0], 0d);
        assertEquals(max + 20, maximums[1], 0d);
        assertEquals(max + 40, maximums[2], 0d);
        ImageUtilities.disposeImage(image);
    }

