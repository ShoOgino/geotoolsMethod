    @Test
    public void testDensification() throws Exception {
        // build a feature source with two zig-zag line occupying the same position
        LiteCoordinateSequence cs = new LiteCoordinateSequence(new double[] {13, 10, 13, 40});
        SimpleFeature line =
                SimpleFeatureBuilder.build(
                        testLineFeatureType, new Object[] {gf.createLineString(cs)}, "zz1");
        DefaultFeatureCollection fc = new DefaultFeatureCollection();
        fc.add(line);
        SimpleFeatureSource zzSource = new CollectionFeatureSource(fc);

        // prepare the map
        MapContent mc = new MapContent();
        StyleBuilder sb = new StyleBuilder();
        mc.addLayer(new FeatureLayer(zzSource, sb.createStyle(sb.createLineSymbolizer())));
        StreamingRenderer sr = new StreamingRenderer();
        Map<Object, Object> hints = new HashMap<>();
        hints.put(StreamingRenderer.ADVANCED_PROJECTION_HANDLING_KEY, true);
        hints.put(StreamingRenderer.ADVANCED_PROJECTION_DENSIFICATION_KEY, true);
        sr.setRendererHints(hints);
        sr.setMapContent(mc);

        /*BufferedImage bi = new BufferedImage(1, 1, BufferedImage.TYPE_3BYTE_BGR);
        Graphics2D graphics = bi.createGraphics();*/
        Graphics2D graphics = Mockito.mock(Graphics2D.class);
        CoordinateReferenceSystem utm32n = CRS.decode("EPSG:32632", true);
        ReferencedEnvelope env = new ReferencedEnvelope(10, 20, 0, 40, WGS84);
        ReferencedEnvelope mapEnv = env.transform(utm32n, true);
        sr.paint(graphics, new Rectangle(0, 0, 100, 100), mapEnv);
        ArgumentCaptor<Shape> shape = ArgumentCaptor.forClass(Shape.class);
        Mockito.verify(graphics).draw(shape.capture());
        LiteShape2 drawnShape = (LiteShape2) shape.getValue();
        assertTrue(drawnShape.getGeometry().getCoordinates().length > 2);
        graphics.dispose();

        hints.put(StreamingRenderer.ADVANCED_PROJECTION_DENSIFICATION_KEY, false);
        sr.setRendererHints(hints);
        graphics = Mockito.mock(Graphics2D.class);
        sr.paint(graphics, new Rectangle(0, 0, 100, 100), mapEnv);
        shape = ArgumentCaptor.forClass(Shape.class);
        Mockito.verify(graphics).draw(shape.capture());
        drawnShape = (LiteShape2) shape.getValue();
        assertEquals(2, drawnShape.getGeometry().getCoordinates().length);
        graphics.dispose();
    }

