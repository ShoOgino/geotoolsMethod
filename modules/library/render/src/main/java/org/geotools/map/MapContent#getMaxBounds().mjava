    /**
     * Get the bounding box of all the layers in this Map. If all the layers cannot determine the
     * bounding box in the speed required for each layer, then null is returned. The bounds will be
     * expressed in the Map coordinate system.
     *
     * @return The bounding box of the features or null if unknown and too expensive for the method
     *     to calculate.
     * @throws IOException if an IOException occurs while accessing the FeatureSource bounds
     */
    public ReferencedEnvelope getMaxBounds() {
        monitor.readLock().lock();
        try {
            CoordinateReferenceSystem mapCrs = null;
            if (viewport != null) {
                mapCrs = viewport.getCoordinateReferenceSystem();
            }
            ReferencedEnvelope maxBounds = null;

            for (Layer layer : layerList) {
                if (layer == null) {
                    continue;
                }
                try {
                    ReferencedEnvelope layerBounds = layer.getBounds();
                    if (layerBounds == null || layerBounds.isEmpty() || layerBounds.isNull()) {
                        continue;
                    }
                    if (mapCrs == null) {
                        // crs for the map is not defined; let us start with the first CRS we see
                        // then!
                        maxBounds = new ReferencedEnvelope(layerBounds);
                        mapCrs = layerBounds.getCoordinateReferenceSystem();
                        continue;
                    }
                    ReferencedEnvelope normalized;
                    if (CRS.equalsIgnoreMetadata(
                            mapCrs, layerBounds.getCoordinateReferenceSystem())) {
                        normalized = layerBounds;
                    } else {
                        try {
                            normalized = layerBounds.transform(mapCrs, true);
                        } catch (Exception e) {
                            LOGGER.log(Level.FINE, "Unable to transform: {0}", e);
                            continue;
                        }
                    }
                    if (maxBounds == null) {
                        maxBounds = normalized;
                    } else {
                        maxBounds.expandToInclude(normalized);
                    }
                } catch (Throwable eek) {
                    LOGGER.log(Level.WARNING, "Unable to determine bounds of " + layer, eek);
                }
            }
            if (maxBounds == null) {
                maxBounds = new ReferencedEnvelope(mapCrs);
            }

            return maxBounds;

        } finally {
            monitor.readLock().unlock();
        }
    }

