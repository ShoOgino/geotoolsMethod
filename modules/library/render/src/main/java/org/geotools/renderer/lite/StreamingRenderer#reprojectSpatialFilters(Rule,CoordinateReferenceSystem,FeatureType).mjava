    /**
     * Reprojects spatial filters so that they match the feature source native CRS, and assuming all
     * literal geometries are specified in the specified declaredCRS
     */
    private Rule reprojectSpatialFilters(
            Rule rule, CoordinateReferenceSystem declaredCRS, FeatureType schema) {
        // NPE avoidance
        Filter filter = rule.getFilter();
        if (filter == null) {
            return rule;
        }

        // try to reproject the filter
        Filter reprojected = reprojectSpatialFilter(declaredCRS, schema, filter);
        if (reprojected == filter) {
            return rule;
        }

        // clone the rule (the style can be reused over and over, we cannot alter it) and set the
        // new filter
        Rule rr = new RuleImpl(rule);
        rr.setFilter(reprojected);
        return rr;
    }

