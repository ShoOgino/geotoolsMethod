    /**
     * Creates the map's bounding box in real world coordinates
     * <p/>
     * 
     * NOTE It is worth to note that here we do not take into account the half a pixel translation
     * stated by ogc for coverages bounds. One reason is that WMS 1.1.1 does not follow it!!!
     * 
     * @param worldToScreen
     *            a transform which converts World coordinates to screen pixel coordinates.
     * @param paintArea
     *            the size of the rendering output area
     */
    public static ReferencedEnvelope createMapEnvelope(Rectangle paintArea,
            AffineTransform worldToScreen, final CoordinateReferenceSystem crs)
            throws NoninvertibleTransformException {

        // //
        //
        // Make sure the CRS is 2d
        //
        // //
        final CoordinateReferenceSystem crs2d = CRS.getHorizontalCRS(crs);
        if (crs2d == null)
            throw new UnsupportedOperationException(Errors.format(
                    ErrorKeys.CANT_REDUCE_TO_TWO_DIMENSIONS_$1, crs));

        Envelope env = createMapEnvelope(paintArea, worldToScreen);
        return new ReferencedEnvelope(env, crs2d);
    }

