    public <T extends Filter> T memoize(
            T filter, Object extraData, BiFunction<T, Object, Object> duplicator) {
        // do we want to memoize this filter?
        if (!memoizeCandidates.contains(filter)) {
            // drill down, this clones and at the same time visits sub-filters
            // (the small parts inside a complex filter are the ones likely to repeat)
            @SuppressWarnings("unchecked")
            T result = (T) duplicator.apply(filter, extraData);
            return result;
        }
        // see if we already built a memoized replacement for it
        @SuppressWarnings("unchecked")
        T replacement = (T) filterReplacements.get(filter);
        if (replacement == null) {
            @SuppressWarnings("unchecked")
            T duplicated = (T) duplicator.apply(filter, extraData);
            replacement = FilterMemoizer.memoize(duplicated);
            filterReplacements.put(filter, replacement);
        }

        return replacement;
    }

