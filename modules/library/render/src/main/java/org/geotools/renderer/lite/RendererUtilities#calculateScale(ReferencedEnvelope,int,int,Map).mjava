    /**
     * First searches the hints for the scale denominator hint otherwise calls {@link
     * #calculateScale(org.geotools.util.SoftValueHashMap.Reference, int, int, double)}. If the
     * hints contains a DPI then that DPI is used otherwise 90 is used (the OGS default).
     */
    public static double calculateScale(
            ReferencedEnvelope envelope, int imageWidth, int imageHeight, Map hints)
            throws TransformException, FactoryException {

        if (hints != null && hints.containsKey("declaredScaleDenominator")) {
            Double scale = (Double) hints.get("declaredScaleDenominator");
            if (scale.doubleValue() <= 0)
                throw new IllegalArgumentException(
                        "the declaredScaleDenominator must be greater than 0, was: "
                                + scale.doubleValue());
            return scale.doubleValue();
        }

        return calculateScale(envelope, imageWidth, imageHeight, getDpi(hints));
    }

