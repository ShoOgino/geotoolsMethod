    /**
     * Extends the provided {@link Envelope} in order to add the number of pixels specified by
     * <code>buffer</code> in every direction.
     *
     * @param envelope to extend.
     * @param worldToScreen by means of which doing the extension.
     * @param buffer to use for the extension.
     * @return an extended version of the provided {@link Envelope}.
     */
    private Envelope expandEnvelope(Envelope envelope, AffineTransform worldToScreen, int buffer) {
        assert buffer > 0;
        double bufferX = Math.abs(buffer * 1.0 / XAffineTransform.getScaleX0(worldToScreen));
        double bufferY = Math.abs(buffer * 1.0 / XAffineTransform.getScaleY0(worldToScreen));
        return new Envelope(
                envelope.getMinX() - bufferX,
                envelope.getMaxX() + bufferX,
                envelope.getMinY() - bufferY,
                envelope.getMaxY() + bufferY);
    }

