    public void testAvoidOptimization() throws Exception {
        // use a made up function that cannot be possibly known by JDBCDataStore,
        // and is not subject to cloning or modifications of any kind 
        Function aggregateFunction = new InternalVolatileFunction() {

            @Override
            public Object evaluate(Object object) {
                return ((SimpleFeature) object).getAttribute("building_type") + "_foo";
            }
        };

        ContentFeatureSource featureSource = dataStore.getFeatureSource(tname("buildings_group_by_tests"));
        SimpleFeatureType featureType = featureSource.getSchema();
        GroupByVisitorBuilder visitorBuilder = new GroupByVisitorBuilder()
                .withAggregateAttribute("energy_consumption", featureType)
                .withAggregateVisitor(Aggregate.MAX);
        visitorBuilder.withGroupByAttribute(aggregateFunction);
        GroupByVisitor visitor = visitorBuilder.build();
        featureSource.accepts(Query.ALL, visitor, null);
        assertFalse(visitor.wasOptimized());
        assertTrue(visitor.wasVisited());
        List<Object[]> value = visitor.getResult().toList();
        assertNotNull(value);

        assertTrue(value.size() == 3);
        checkValueContains(value, "HOUSE_foo", "6.0");
        checkValueContains(value, "FABRIC_foo", "500.0");
        checkValueContains(value, "SCHOOL_foo", "60.0");
    }

