    private void writeEncodedField(
            Class<?> target, PropertyName expression, AttributeDescriptor attribute)
            throws IOException {
        String encodedField;
        if (attribute != null) {
            encodedField = fieldEncoder.encode(escapeName(attribute.getLocalName()));
            if (target != null && target.isAssignableFrom(attribute.getType().getBinding())) {
                // no need for casting, it's already the right type
                target = null;
            }
        } else {
            // fall back to just encoding the property name
            encodedField = fieldEncoder.encode(escapeName(expression.getPropertyName()));
        }

        // handle destination type if necessary
        if (target != null) {
            out.write(cast(encodedField, target));
        } else {
            out.write(encodedField);
        }
    }

