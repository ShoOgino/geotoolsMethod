    FilterToSQL filter(
            SimpleFeatureType featureType, Filter filter, StringBuffer sql, FilterToSQL toSQL)
            throws IOException {
        try {
            // grab the full feature type, as we might be encoding a filter
            // that uses attributes that aren't returned in the results
            SimpleFeatureType fullSchema = getSchema(featureType.getTypeName());
            toSQL.setInline(true);
            String filterSql = toSQL.encodeToString(filter);
            int whereClauseIndex = sql.indexOf(WHERE_CLAUSE_PLACE_HOLDER);
            if (whereClauseIndex != -1) {
                sql.replace(
                        whereClauseIndex,
                        whereClauseIndex + WHERE_CLAUSE_PLACE_HOLDER_LENGTH,
                        "AND " + filterSql);
                sql.append("1 = 1");
            } else {
                sql.append(filterSql);
            }
            return toSQL;
        } catch (FilterToSQLException e) {
            throw new RuntimeException(e);
        }
    }

