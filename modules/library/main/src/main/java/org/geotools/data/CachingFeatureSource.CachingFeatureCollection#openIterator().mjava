        @Override
        protected Iterator openIterator() {
            List features;
            synchronized (CachingFeatureSource.this) {
                try {
                    if (index == null || dirty || !isSubQuery(query)) {
                        fillCache(query);
                    }
                    if (queryBounds != null) {
                        features = index.query(queryBounds);
                    } else {
                        features = index.query((Envelope) index.getRoot().getBounds());
                    }
                } catch (Exception e) {
                    throw new RuntimeException("Failed to get data", e);
                }
            }
            SimpleFeatureCollection fc = new ListFeatureCollection(schema, features);
            if (query.getFilter() != null && Filter.INCLUDE.equals(query.getFilter())) {
                fc = new FilteringSimpleFeatureCollection(fc, query.getFilter());
            }
            if (targetSchema != sourceSchema) {
                fc = new ReTypingFeatureCollection(fc, targetSchema);
            }
            SimpleFeature[] results = fc.toArray(new SimpleFeature[fc.size()]);
            return Arrays.asList(results).iterator();
        }

