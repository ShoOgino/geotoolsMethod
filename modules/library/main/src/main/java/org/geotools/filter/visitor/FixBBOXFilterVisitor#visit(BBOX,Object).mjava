    @Override
    public Object visit(BBOX filter, Object extraData) {
        Envelope bbox = null;
        Expression leftGeometry = filter.getExpression1();
        Expression rightGeometry = filter.getExpression2();
        boolean clipped = false;

        Literal le = null;
        if (leftGeometry != null && leftGeometry instanceof Literal) {
            le = (Literal) leftGeometry;
        } else if (rightGeometry != null && rightGeometry instanceof Literal) {
            le = (Literal) rightGeometry;
        }
        CoordinateReferenceSystem crs = null;
        if (le != null && le.getValue() != null && le.getValue() instanceof Geometry) {
            Geometry geometry = (Geometry) le.getValue();
            bbox = geometry.getEnvelopeInternal();
            crs = (CoordinateReferenceSystem) geometry.getUserData();
        } else if (le != null
                && le.getValue() != null
                && le.getValue() instanceof ReferencedEnvelope) {
            bbox = (Envelope) le.getValue();
            crs = ((ReferencedEnvelope) le.getValue()).getCoordinateReferenceSystem();
        }
        if (bbox == null) {
            // huh? no literal? Allow super class to sort it out ...
            return super.visit(filter, extraData); // allow super class to make a direct copy
        }

        double minx = bbox.getMinX();
        double miny = bbox.getMinY();
        double maxx = bbox.getMaxX();
        double maxy = bbox.getMaxY();
        if (maxbbox != null) {
            if (minx < maxbbox.getMinX()) {
                minx = maxbbox.getMinX();
                clipped = true;
            }
            if (maxx > maxbbox.getMaxX()) {
                maxx = maxbbox.getMaxX();
                clipped = true;
            }
            if (miny < maxbbox.getMinY()) {
                miny = maxbbox.getMinY();
                clipped = true;
            }
            if (maxy > maxbbox.getMaxY()) {
                maxy = maxbbox.getMaxY();
                clipped = true;
            }
        }
        if (clipped) {
            // the bbox was clipped!
            FilterFactory2 ff = getFactory(extraData);
            return ff.bbox(
                    filter.getExpression1(),
                    ff.literal(new ReferencedEnvelope(minx, maxx, miny, maxy, crs)));
        } else {
            return super.visit(filter, extraData); // allow super class to make a direct copy
        }
    }

