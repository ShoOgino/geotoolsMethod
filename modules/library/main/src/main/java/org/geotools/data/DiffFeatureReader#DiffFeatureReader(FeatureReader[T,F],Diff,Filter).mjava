    /**
     * This constructor grabs a "copy" of the current diff.
     *
     * <p>This reader is not "live" to changes over the course of the Transaction. (Iterators are
     * not always stable of the course of modifications)
     *
     * @param reader
     * @param diff2 Differences of Feature by FID
     */
    public DiffFeatureReader(FeatureReader<T, F> reader, Diff diff2, Filter filter) {
        this.reader = reader;
        this.diff = diff2;
        this.filter = filter;
        encounteredFids = new HashSet();

        if (filter instanceof Id) {
            fidFilter = true;
        } else if (isSubsetOfBboxFilter(filter)) {
            indexedGeometryFilter = true;
        }

        synchronized (diff) {
            if (indexedGeometryFilter) {
                spatialIndexIterator = getIndexedFeatures().iterator();
            }
            addedIterator = (Iterator<F>) diff.getAdded().values().iterator();
            modifiedIterator = (Iterator<F>) diff.getModified().values().iterator();
        }
    }

