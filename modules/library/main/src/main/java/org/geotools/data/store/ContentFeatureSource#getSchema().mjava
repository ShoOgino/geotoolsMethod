    /**
     * Returns the feature type or the schema of the feature source.
     *
     * <p>This method delegates to {@link #buildFeatureType()}, which must be implemented by
     * subclasses. The result is cached in {@link ContentState#getFeatureType()}.
     */
    public final SimpleFeatureType getSchema() {

        // check schema override
        if (schema != null) {
            return schema;
        }

        SimpleFeatureType featureType = getAbsoluteSchema();

        // this may be a view
        if (query != null && query.getPropertyNames() != Query.ALL_NAMES) {
            synchronized (this) {
                if (schema == null) {
                    schema = SimpleFeatureTypeBuilder.retype(featureType, query.getPropertyNames());
                }
            }

            return schema;
        }

        return featureType;
    }

