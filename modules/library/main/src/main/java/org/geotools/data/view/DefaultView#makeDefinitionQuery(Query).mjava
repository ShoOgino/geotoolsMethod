    /**
     * Takes a query and adapts it to match re definitionQuery filter configured for a feature type.
     * It won't handle coordinate system changes
     *
     * <p>Grabs the following from query:
     *
     * <ul>
     *   <li>typeName - only used if client does not supply
     *   <li>filter - combined with client filter
     *   <li>propertyNames - combined with client filter (indicate property names that *must* be
     *       included)
     * </ul>
     *
     * @param query Query against this DataStore
     * @return Query restricted to the limits of definitionQuery
     * @throws IOException See DataSourceException
     * @throws DataSourceException If query could not meet the restrictions of definitionQuery
     */
    protected Query makeDefinitionQuery(Query query) throws IOException {
        if ((query == Query.ALL) || query.equals(Query.ALL)) {
            return new Query(constraintQuery);
        }

        try {
            String[] propNames = extractAllowedAttributes(query);

            String typeName = query.getTypeName();
            if (typeName == null) {
                typeName = constraintQuery.getTypeName();
            }

            URI namespace = query.getNamespace();
            if (namespace == null || namespace == Query.NO_NAMESPACE) {
                namespace = constraintQuery.getNamespace();
            }
            Filter filter = makeDefinitionFilter(query.getFilter());

            int maxFeatures = Math.min(query.getMaxFeatures(), constraintQuery.getMaxFeatures());

            String handle = query.getHandle();
            if (handle == null) {
                handle = constraintQuery.getHandle();
            } else if (constraintQuery.getHandle() != null) {
                handle = handle + "(" + constraintQuery.getHandle() + ")";
            }

            Query Query = new Query(typeName, namespace, filter, maxFeatures, propNames, handle);
            Query.setSortBy(query.getSortBy());
            return Query;
        } catch (Exception ex) {
            throw new DataSourceException(
                    "Could not restrict the query to the definition criteria: " + ex.getMessage(),
                    ex);
        }
    }

