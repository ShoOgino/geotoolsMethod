    /**
     * Safe version of FilterFactory *and* that is willing to combine filter1 and filter2 correctly
     * in the even either of them is already an And filter.
     *
     * @param ff
     * @param filter1
     * @param filter2
     * @return And
     */
    public static Filter and(org.opengis.filter.FilterFactory ff, Filter filter1, Filter filter2) {
        ArrayList<Filter> list = new ArrayList<Filter>(2);
        if (filter1 instanceof And) {
            And some = (And) filter1;
            list.addAll(some.getChildren());
        } else if (filter1 != null) {
            list.add(filter1);
        }

        if (filter2 instanceof And) {
            And more = (And) filter2;
            list.addAll(more.getChildren());
        } else if (filter2 != null) {
            list.add(filter2);
        }

        if (list.size() == 0) {
            return Filter.EXCLUDE;
        } else if (list.size() == 1) {
            return list.get(0);
        } else {
            return ff.and(list);
        }
    }

