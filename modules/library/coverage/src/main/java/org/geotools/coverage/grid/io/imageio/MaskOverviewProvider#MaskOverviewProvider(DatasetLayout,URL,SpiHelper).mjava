    public MaskOverviewProvider(DatasetLayout layout, URL inputFile, SpiHelper spiProvider) throws IOException {
        ImageReaderSpi suggestedSPI = spiProvider.getSuggestedSpi();
        ImageInputStreamSpi suggestedStreamSPI = spiProvider.getSuggestedStreamSpi();
        readerSpi = spiProvider.getReaderSpi();
        streamSpi = spiProvider.getStreamSpi();
        this.fileURL = spiProvider.getFileURL();
        this.layout = layout;

        // Handling Overviews
        ovrURL = new URL(inputFile.toString() + OVR_EXTENSION);
        hasDatasetLayout = layout != null;
        if (hasDatasetLayout && layout.getExternalOverviews() != null) {
            ovrURL = URLs.fileToUrl(layout.getExternalOverviews());
        }
        // Creating overview file URL
        overviewStreamSpi = suggestedStreamSPI == null ? getInputStreamSPIFromURL(ovrURL) : suggestedStreamSPI;
        ImageInputStream ovrStream = null;
        try {
            ovrStream = overviewStreamSpi.createInputStreamInstance(ovrURL, ImageIO.getUseCache(),
                    ImageIO.getCacheDirectory());
            if (ovrStream == null) {
                // No Overview file so we fall back to the original file spis
                overviewStreamSpi = streamSpi;
                overviewReaderSpi = readerSpi;
            } else {
                overviewReaderSpi = getReaderSpiFromStream(null, ovrStream);
            }
        } catch (Exception e) {
            if (LOGGER.isLoggable(Level.WARNING)) {
                LOGGER.log(Level.WARNING, "Unable to create a Reader for File: " + ovrURL, e);
            }
            throw new IllegalArgumentException(e);
        } finally {
            if (ovrStream != null) {
                try {
                    ovrStream.close();
                } catch (Exception e) {
                    if (LOGGER.isLoggable(Level.SEVERE)) {
                        LOGGER.log(Level.SEVERE, e.getMessage(), e);
                    }
                }
            }
        }

        // Getting number of Overviews
        int numOverviews = 0;
        if (hasDatasetLayout) {
            numInternalOverviews = layout.getNumInternalOverviews();
            // layout.getNumExternalOverviews() may return -1 when no external file is present
            numExternalOverviews = layout.getNumExternalOverviews() > 0 ? layout
                    .getNumExternalOverviews() : 0;
            numOverviews = numInternalOverviews + numExternalOverviews;
        } else if (!spiProvider.isMultidim()){
            // Reading image number
            ImageInputStream imageStream = null;
            ImageReader reader = null;
            try {
                // Creating stream
                imageStream = streamSpi.createInputStreamInstance(fileURL, ImageIO.getUseCache(),
                        ImageIO.getCacheDirectory());
                // Creating reader
                reader = readerSpi.createReaderInstance();
                // Setting input
                reader.setInput(imageStream, false, false);
                // Getting number of images
                numOverviews = reader.getNumImages(true) - 1;
                // Setting numInternalOverviews
                numInternalOverviews = numOverviews;
            } catch (Exception e) {
                if (LOGGER.isLoggable(Level.WARNING)) {
                    LOGGER.log(Level.WARNING,
                            "Unable to create a Reader for File: " + inputFile,
                            e);
                }
                throw new IllegalArgumentException(e);
            } finally {
                if (imageStream != null) {
                    try {
                        imageStream.close();
                    } catch (Exception e) {
                        if (LOGGER.isLoggable(Level.SEVERE)) {
                            LOGGER.log(Level.SEVERE, e.getMessage(), e);
                        }
                    } finally {
                        if (reader != null) {
                            reader.dispose();
                        }
                    }
                }
            }
        }
        if (numOverviews < 0) {
            numOverviews = 0;
        }
        // Setting overviews Number
        this.numOverviews = numOverviews;

        // Mask Management
        if (layout != null) {
            numInternalMasks = layout.getNumInternalMasks();
            numExternalMasks = layout.getNumExternalMasks() > 0 ? layout.getNumExternalMasks() : 0;
            numExternalMasksOverviews = layout.getNumExternalMaskOverviews() > 0 ? layout
                    .getNumExternalMaskOverviews() : 0;
            hasExternalMasks = numExternalMasks > 0;
            hasExternalMasksOverviews = hasExternalMasks && numExternalMasksOverviews > 0;
            if (hasExternalMasks) {
                // Mask URL
                maskURL = URLs.fileToUrl(layout.getExternalMasks());
                // Creating cached SPIs
                maskStreamSpi = getInputStreamSPIFromURL(maskURL);
                ImageInputStream maskStream = null;
                try {
                    maskStream = maskStreamSpi.createInputStreamInstance(maskURL,
                            ImageIO.getUseCache(), ImageIO.getCacheDirectory());
                    maskReaderSpi = getReaderSpiFromStream(suggestedSPI, maskStream);
                } catch (Exception e) {
                    if (LOGGER.isLoggable(Level.WARNING)) {
                        LOGGER.log(Level.WARNING, "Unable to create a Reader for File: " + maskURL,
                                e);
                    }
                    throw new IllegalArgumentException(e);
                } finally {
                    if (maskStream != null) {
                        try {
                            maskStream.close();
                        } catch (Exception e) {
                            if (LOGGER.isLoggable(Level.SEVERE)) {
                                LOGGER.log(Level.SEVERE, e.getMessage(), e);
                            }
                        }
                    }
                }
                // Handling external mask overviews
                if (hasExternalMasksOverviews) {
                    // Mask URL
                    maskOvrURL = URLs.fileToUrl(layout.getExternalMaskOverviews());
                    // Creating cached SPIs
                    maskOvrStreamSpi = getInputStreamSPIFromURL(maskOvrURL);
                    ImageInputStream maskOvrStream = null;
                    try {
                        maskOvrStream = maskOvrStreamSpi.createInputStreamInstance(maskOvrURL,
                                ImageIO.getUseCache(), ImageIO.getCacheDirectory());
                        maskOvrReaderSpi = getReaderSpiFromStream(suggestedSPI, maskOvrStream);
                    } catch (Exception e) {
                        if (LOGGER.isLoggable(Level.WARNING)) {
                            LOGGER.log(Level.WARNING, "Unable to create a Reader for File: "
                                    + maskOvrURL, e);
                        }
                        throw new IllegalArgumentException(e);
                    } finally {
                        if (maskOvrStream != null) {
                            try {
                                maskOvrStream.close();
                            } catch (Exception e) {
                                if (LOGGER.isLoggable(Level.SEVERE)) {
                                    LOGGER.log(Level.SEVERE, e.getMessage(), e);
                                }
                            }
                        }
                    }
                } else {
                    // No Mask Overview file so we fall back to the original mask spis
                    maskOvrStreamSpi = maskStreamSpi;
                    maskOvrReaderSpi = maskReaderSpi;
                }
            } else {
                // No Mask file so we fall back to the original file spis
                maskStreamSpi = streamSpi;
                maskReaderSpi = readerSpi;
            }
        }
    }

