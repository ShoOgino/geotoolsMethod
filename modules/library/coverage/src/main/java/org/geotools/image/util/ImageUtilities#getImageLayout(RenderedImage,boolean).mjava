    /**
     * Returns an {@link ImageLayout} for the specified image. If {@code initToImage} is {@code
     * true}, then all parameters are initially set equal to those of the given {@link
     * RenderedImage} and the returned layout is never {@code null} (except if the image is null).
     */
    private static ImageLayout getImageLayout(
            final RenderedImage image, final boolean initToImage) {
        if (image == null) {
            return null;
        }
        ImageLayout layout = initToImage ? new ImageLayout(image) : null;
        if ((image.getNumXTiles() == 1 || image.getTileWidth() < STRIPE_SIZE)
                && (image.getNumYTiles() == 1 || image.getTileHeight() < STRIPE_SIZE)) {
            // If the image was already tiled, reuse the same tile size.
            // Otherwise, compute default tile size.  If a default tile
            // size can't be computed, it will be left unset.
            if (layout != null) {
                layout = layout.unsetTileLayout();
            }
            Dimension defaultSize = JAI.getDefaultTileSize();
            if (defaultSize == null) {
                defaultSize = GEOTOOLS_DEFAULT_TILE_SIZE;
            }
            int sw;
            int sh;
            sw = toTileSize(image.getWidth(), defaultSize.width);
            sh = toTileSize(image.getHeight(), defaultSize.height);
            boolean smallTileWidth = image.getTileWidth() <= STRIPE_SIZE;
            boolean smallTileHeight = image.getTileHeight() < STRIPE_SIZE;
            if (sw != 0 || sh != 0 || smallTileHeight || smallTileWidth) {
                if (layout == null) {
                    layout = new ImageLayout();
                }
                if (sw != 0) {
                    layout = layout.setTileWidth(sw);
                    layout.setTileGridXOffset(image.getMinX());
                } else if (smallTileWidth) {
                    layout = layout.setTileWidth(defaultSize.width);
                } else {
                    layout = layout.setTileWidth(image.getTileWidth());
                }
                if (sh != 0) {
                    layout = layout.setTileHeight(sh);
                    layout.setTileGridYOffset(image.getMinY());
                } else if (smallTileHeight) {
                    layout = layout.setTileHeight(defaultSize.height);
                } else {
                    layout = layout.setTileHeight(image.getTileHeight());
                }
            }
        }
        return layout;
    }

