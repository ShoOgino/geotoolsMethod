    @Test
    public void testOptimizedWarp() throws Exception {
        // do it again, make sure the image does not turn black since
        GridCoverage2D ushortCoverage = EXAMPLES.get(5);
        GridCoverage2D coverage = project(ushortCoverage, CRS.parseWKT(GOOGLE_MERCATOR_WKT), null,
                "nearest", null);
        RenderedImage ri = coverage.getRenderedImage();

        ImageWorker.WARP_REDUCTION_ENABLED = false;
        AffineTransform at = new AffineTransform(0.4, 0, 0, 0.5, -200, -200);
        RenderedOp fullChain = (RenderedOp) new ImageWorker(ri).affine(at,
                Interpolation.getInstance(Interpolation.INTERP_NEAREST), new double[] { 0 })
                .getRenderedImage();
        assertEquals(ImageWorker.SCALE_OP_NAME, fullChain.getOperationName());
        fullChain.getTiles();
        assertNoData(fullChain, null);

        ImageWorker.WARP_REDUCTION_ENABLED = true;
        RenderedOp reduced = (RenderedOp) new ImageWorker(ri).affine(at,
                Interpolation.getInstance(Interpolation.INTERP_NEAREST), new double[] { 0 })
                .getRenderedImage();
        // force computation, to make sure it does not throw exceptions
        reduced.getTiles();
        // check the chain has been reduced
        assertEquals("Warp", reduced.getOperationName());
        assertEquals(1, reduced.getSources().size());
        assertSame(ushortCoverage.getRenderedImage(), reduced.getSourceImage(0));
        assertNoData(reduced, null);

        // check the bounds of the output image has not changed
        assertEquals(fullChain.getBounds(), reduced.getBounds());

        // check we are getting a reasonable tile size and origin (JAI warp_affine will generate
        // odd results otherwise
        assertEquals(0, reduced.getTileGridXOffset());
        assertEquals(0, reduced.getTileGridYOffset());
        assertEquals(ushortCoverage.getRenderedImage().getTileWidth(), reduced.getTileWidth());
        assertEquals(ushortCoverage.getRenderedImage().getTileHeight(), reduced.getTileHeight());
    }

