    @Test
    public void testArrayIndexOutOfBounds() {
        // hard to reproduce bug, the sizes and actions here have been carefully crafted
        // to make it happen
        WeakValueHashMap<Integer, Integer> map = new WeakValueHashMap<>(10);
        List<Integer> values = new ArrayList<>();
        for (int i = 0; i < 7; i++) {
            Integer v = Integer.valueOf(i);
            values.add(v);
            map.put(v, v);
        }
        Integer last = Integer.valueOf(9);
        map.put(last, last);

        // reduce the size enough that we put the map on its threshold for shrinking
        for (int i = 0; i < 5; i++) {
            map.remove(Integer.valueOf(i));
        }

        // now replace the last element, which will force the map to shrink
        last = Integer.valueOf(9);
        values.add(last);
        map.put(last, last); // it used to throw the arrays out of bound here

        assertEquals(3, map.size());
        assertTrue(map.containsKey(Integer.valueOf(5)));
        assertTrue(map.containsKey(Integer.valueOf(6)));
        assertTrue(map.containsKey(Integer.valueOf(9)));
    }

