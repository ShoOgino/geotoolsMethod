    /** Tests for GEOT-2817 */
    @Test
    public void testLookupWithSameFactoryInTwoClassLoaders()
            throws IOException, ClassNotFoundException {
        // create url to this project's classes
        URL projectClasses = getClass().getResource("/");
        // create 2 classloaders with parent null to avoid delegation to the system class loader !
        // this occurs in reality with split class loader hierarchies (e.g. GWT plugin and
        // some application servers)
        try (URLClassLoader cl1 = new URLClassLoader(new URL[] {projectClasses}, null);
                URLClassLoader cl2 = new URLClassLoader(new URL[] {projectClasses}, null)) {
            // extend with both class loaders
            GeoTools.addClassLoader(cl1);
            GeoTools.addClassLoader(cl2);
            // code below was throwing ClassCastException (before java 7) prior to adding
            // isAssignableFrom() check (line 862)
            for (int i = 0; i < 2; i++) {
                ClassLoader loader = (i == 0 ? cl1 : cl2);
                Class dummy = loader.loadClass("org.geotools.util.factory.DummyInterface");
                FactoryRegistry reg = new FactoryCreator(dummy);
                reg.scanForPlugins();
                // we are mocking with two class loaders, trying to make it type safe will make
                // the factory fail to load the factory
                @SuppressWarnings("unchecked")
                Optional factory = reg.getFactories(dummy, false).findFirst();
                assertTrue(factory.isPresent());
                // factory class should have same class loader as interface
                assertSame(loader, factory.get().getClass().getClassLoader());
            }
        }
    }

