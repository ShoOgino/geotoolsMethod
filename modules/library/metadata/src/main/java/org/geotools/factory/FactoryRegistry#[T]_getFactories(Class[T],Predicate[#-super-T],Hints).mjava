    // TODO: document; filter and hints can be null
    public synchronized <T> Stream<T> getFactories(final Class<T> category, final Predicate<? super T> filter, final Hints hints) {
        /*
         * The implementation of this method is very similar to the 'getUnfilteredFactories'
         * one except for filter handling. See the comments in 'getUnfilteredFactories' for
         * more implementation details.
         */
        if (scanningCategories.contains(category)) {
            // Please note you will get errors here if you accidentally allow
            // more than one thread to use your FactoryRegistry at a time.
            throw new RecursiveSearchException(category);
        }
        synchronizeIteratorProviders();
        scanForPluginsIfNeeded(category);
        Predicate<T> isAcceptable = factory -> isAcceptable(category.cast(factory), category, hints, filter);
        return getFactories(category, isAcceptable, true);
    }

