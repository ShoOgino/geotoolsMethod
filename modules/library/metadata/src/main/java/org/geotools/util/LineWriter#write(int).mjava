    /**
     * Writes a single character.
     *
     * @throws IOException If an I/O error occurs.
     */
    @Override
    public void write(final int c) throws IOException {
        synchronized (lock) {
            switch (c) {
                case '\r':
                    {
                        assert bufferBlank();
                        count = 0; // Discard whitespaces
                        writeEOL();
                        skipCR = true;
                        break;
                    }
                case '\n':
                    {
                        if (!skipCR) {
                            assert bufferBlank();
                            count = 0; // Discard whitespaces
                            writeEOL();
                        }
                        skipCR = false;
                        break;
                    }
                default:
                    {
                        if (c >= Character.MIN_VALUE
                                && c <= Character.MAX_VALUE
                                && isWhitespace((char) c)) {
                            if (count >= buffer.length) {
                                buffer = XArray.resize(buffer, count + Math.min(8192, count));
                            }
                            buffer[count++] = (char) c;
                        } else {
                            flushBuffer();
                            out.write(c);
                        }
                        skipCR = false;
                        break;
                    }
            }
        }
    }

