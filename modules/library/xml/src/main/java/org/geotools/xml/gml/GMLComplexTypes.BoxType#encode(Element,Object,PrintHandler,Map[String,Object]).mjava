        /**
         * @see org.geotools.xml.schema.Type#encode(org.geotools.xml.schema.Element,
         *     java.lang.Object, org.geotools.xml.PrintHandler, java.util.Map)
         */
        @Override
        public void encode(
                Element element, Object value, PrintHandler output, Map<String, Object> hints)
                throws IOException, OperationNotSupportedException {
            if (!canEncode(element, value, hints)) {
                throw new OperationNotSupportedException("Cannot encode " + value);
            }
            if (value instanceof ReferencedEnvelope) {
                ReferencedEnvelope bbox = (ReferencedEnvelope) value;
                AttributesImpl ai = new AttributesImpl();

                // no GID
                if (bbox != null && bbox.getCoordinateReferenceSystem() != null) {
                    // TODO Fix this when parsing is better ... should be a coord reference system
                    String srsName = CRS.toSRS(bbox.getCoordinateReferenceSystem());
                    ai.addAttribute("", "srsName", "", "anyURI", srsName);
                } else {
                    ai = null;
                }

                if (bbox == null || bbox.isNull() || bbox.isEmpty()) {
                    return;
                }
                // we handle the case for a null element, see canEncode for details
                if (element != null) {
                    output.startElement(GMLSchema.NAMESPACE, element.getName(), ai);
                } else {
                    output.startElement(GMLSchema.NAMESPACE, "Box", ai);
                }

                // Coordinate[] coords = g.getCoordinates();
                Envelope e = bbox;
                encodeCoords(elements[1], e, output);

                if (element != null) {
                    output.endElement(GMLSchema.NAMESPACE, element.getName());
                } else {
                    output.endElement(GMLSchema.NAMESPACE, "Box");
                }
            } else {
                Geometry g = (Geometry) value;

                if ((g == null) || (g.getNumPoints() == 0) || (g.getCoordinates().length == 0)) {
                    return;
                }

                AttributesImpl ai = getSrsNameAttribute(g);

                // we handle the case for a null element, see canEncode for details
                if (element != null) {
                    output.startElement(GMLSchema.NAMESPACE, element.getName(), ai);
                } else {
                    output.startElement(GMLSchema.NAMESPACE, "Box", ai);
                }

                //            Coordinate[] coords = g.getCoordinates();
                Envelope e = g.getEnvelopeInternal();
                encodeCoords(elements[1], e, output);

                if (element != null) {
                    output.endElement(GMLSchema.NAMESPACE, element.getName());
                } else {
                    output.endElement(GMLSchema.NAMESPACE, "Box");
                }
            }
        }

